---
title: "Untitled"
author: "Ludvig Larsson"
date: "2023-07-14"
output: html_document
---

wrong script

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(tidyr)
library(RcppML)
```

Load `Seurat` object with ST data

```{r}
getwd()
ST <- readRDS("../data/ST/220114_STdata_harmony_semla.rds")
```

The object was created by Zaneta using `STUtility`. I would recommend creating a new `Seurat` object with semla since you have a new environment up and running. The code below demonstrated how you can plot the results using custom code, but it would be much easier if you have semla installed. I didn't have access to the raw Visium data so I never tried.
 
## Get coordinates

```{r eval=FALSE}
coords <- ST@tools$Staffli@meta.data
exprMat <- GetAssayData(ST, slot = "data")
```

## Load stereoscope results for sampled cells

```{r}
# Replace path with the latest results
stereoscope <- read.table("../stereoscope_230711/sampled_cells/hdca_heart_ST_data/W.2023-07-11154535.441323.tsv", check.names = FALSE)

# Find shares genes
all(rownames(coords) == rownames(stereoscope))

```

## Plot stereoscope results for sampled cells

```{r eval=FALSE}
gg <- tibble(coords |> select(sample, pixel_x, pixel_y), 
             ST@meta.data,
             stereoscope |> as.data.frame())
for (celltype in colnames(stereoscope)) {
  print(celltype)
  p <- ggplot(gg, 
         aes(pixel_x, pixel_y, color = !! sym(celltype))) +
    coord_fixed() +
    geom_point() +
    scale_y_reverse() +
    theme_void() +
    scale_color_gradientn(colours = viridis::magma(n = 11, direction = -1)) +
    facet_wrap(~section.name) +
    theme(strip.text = element_text(size = 12, colour = "black", face = "bold"))
  
  jpeg(filename = paste0("../stereoscope_230711/plots/spatial_maps_sampled_cells/", celltype, ".jpg"), 
       width = 7000, height = 7000, res = 200)
  print(p)
  dev.off()
}
```
