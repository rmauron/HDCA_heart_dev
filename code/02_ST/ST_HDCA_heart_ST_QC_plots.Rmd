---
title: "ST_HDCA_heart_ST_QC_plots"
author: "Raphaël Mauron"
output: html_document
editor_options: 
  chunk_output_type: console
---

# HDCA heart ST Quality plots

This script presents the quality plots performed for this analysis.

NOTE: The path to load the data and the path to save the figures should be changed at your convenience.

Environment: **Conda: r-semla**

## Set up and loading material

### Knit setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### Load library

```{r}
library(semla)
library(tidyr)
library(RcppML)
library(ggplot2)
library(openxlsx)
```


### Set working directory

```{r}
myfolder <- "~/hdca_DevHeart/output/HDCA_heart_sc_analysis_docker/complementary/ST/"
```


### Load `Seurat` object with ST data

```{r}
ST <- readRDS("~/hdca_DevHeart/data/ST/220114_STdata_harmony_semla.rds")
ST_clustering <- readRDS("~/hdca_DevHeart/data/ST/HDCA_heart_clustering.rds")
```


### Update image paths

```{r}
image_files <- list.files(path = "~/hdca_DevHeart/data/ST", 
                          pattern = "tissue_hires_image.png", 
                          full.names = TRUE, 
                          recursive = TRUE)
ST@tools$Staffli@imgs <- image_files
```


### Load H&E images

```{r}
ST <- LoadImages(ST, image_height = 1.5e3)
```


### Add section ID's to the ST object

```{r}
ST$sample_id <- paste0("section_", GetCoordinates(ST)$sampleID)
```


## Age specific cell type co-localization

```{r}
ST_meta_data <- openxlsx::read.xlsx("~/hdca_DevHeart/data/ST/HDCA_heart_ST_sections_overview_chambers_present.xlsx")
ST_meta_data$age <- as.numeric(gsub("[^0-9.]", "", ST_meta_data$Age))

ST_meta_data <- select(ST_meta_data, Section, age)
ST_meta_data$sample_id <- paste0("section_", ST_meta_data$Section)
ST_meta_data
```


### Re-order sample by setting factors

```{r}
ST$sample_id <- factor(ST$sample_id, levels = unique(ST_meta_data$sample_id))
```


## Plot section with H&E image - QC ST

### Set default assay to `Spatial´

```{r}
DefaultAssay(ST) <- "Spatial"
```


### Check clusters name - example

```{r}
head(rownames(ST), 10)
```


### Plot MapFeatures nCount - nFeature for 4 sections of interest

#### nCount

##### section 5, 2, 11, 24 (Extended Fig. 1D)

```{r fig.asp=0.7}
plots <- MapFeatures(ST,
            features = "nCount_Spatial",
            override_plot_dims = TRUE,
            colors = c("white", "red", "black"),
            pt_size = 1.6) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()

p5 <- plots[[5]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p2 <- plots[[2]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p11 <- plots[[11]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p24 <- plots[[24]] & theme(plot.subtitle = element_blank(), legend.position = "right", legend.text = element_text(angle = 0))


p <- p5 + p2 + p11 + p24  +
  patchwork::plot_layout(ncol = 4) 

pdf(file = paste0(myfolder, "nCount_section_5_2_11_24.pdf"), width = 15.75, height = 4.5)
p
dev.off()
```


#### nFeature

##### section 5, 2, 11, 24 (Extended Fig. 1D)

```{r fig.asp=0.7}
plots <- MapFeatures(ST,
            features = "nFeature_Spatial",
            override_plot_dims = TRUE,
            colors = c("white", "red", "black"),
            pt_size = 1.6) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()

p5 <- plots[[5]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p2 <- plots[[2]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p11 <- plots[[11]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p24 <- plots[[24]] & theme(plot.subtitle = element_blank(), legend.position = "right", legend.text = element_text(angle = 0))


p <- p5 + p2 + p11 + p24  +
  patchwork::plot_layout(ncol = 4) 

pdf(file = paste0(myfolder, "nFeature_section_5_2_11_24.pdf"), width = 15.75, height = 4.5)
p
dev.off()
```


### Plot gender marker accross every sections

#### KDM5D (Extended Fig. 1B)

```{r fig.asp=0.7}
jpeg(filename = paste0(myfolder, "/KDM5D.jpg"), width = 4000, height = 4000, res = 150)
MapFeatures(ST,
            features = "KDM5D",
            override_plot_dims = T,
            colors = c("lightgrey","mistyrose", "red", "darkred", "black"),
            pt_size = 1.6) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()
dev.off()
```


## Violin plots (Extended Fig. 1C)

### nCount

```{r}
pdf(paste0(myfolder, "/QC_Violin_nCount_ST.pdf"), width = 16, height = 5)
VlnPlot(ST, features = "nCount_Spatial", group.by = "sample_id", pt.size = 0.1) + NoLegend() + theme(axis.text.x = element_text(size = 20),
                                                                                                     axis.text.y = element_text(size = 20))
dev.off()

pdf(paste0(myfolder, "/QC_Violin_nCount_ST_no_point.pdf"), width = 16, height = 5)
VlnPlot(ST, features = "nCount_Spatial", group.by = "sample_id", pt.size = 0) + NoLegend() + theme(axis.text.x = element_text(size = 20),
                                                                                                     axis.text.y = element_text(size = 20))
dev.off()
```

### nFeature

```{r}
pdf(paste0(myfolder, "/QC_Violin_nFeature_ST.pdf"), width = 16, height = 5)
VlnPlot(ST, features = "nFeature_Spatial", group.by = "sample_id", pt.size = 0.1) + NoLegend() + theme(axis.text.x = element_text(size = 20),
                                                                                                     axis.text.y = element_text(size = 20))
dev.off()

pdf(paste0(myfolder, "/QC_Violin_nFeature_ST_no_point.pdf"), width = 16, height = 5)
VlnPlot(ST, features = "nFeature_Spatial", group.by = "sample_id", pt.size = 0) + NoLegend() + theme(axis.text.x = element_text(size = 20),
                                                                                                     axis.text.y = element_text(size = 20))
dev.off()
```


## Spatial Clustering 

### All 17 kept sections

```{r}
pdf(file = paste0(myfolder, "ST_umap_allspots.pdf"), width = 15, height = 15, bg = "transparent")
DimPlot(ST_clustering, reduction = "umap")
dev.off()
```


### Temporal UMAP (Supp Fig. 1C)

```{r}
table(ST_clustering$age)
```

```{r}
ST_clustering_1 <- ST_clustering[, ST_clustering$age %in% c("w6", "w7")]
ST_clustering_2 <- ST_clustering[, ST_clustering$age %in% c("w8", "w9")]
ST_clustering_3 <- ST_clustering[, ST_clustering$age %in% c("w10", "w10.5", "w12")]
```

```{r}
table(ST_clustering_1$age)
table(ST_clustering_2$age)
table(ST_clustering_3$age)
```


#### Check cell group (age) with the fewest cells

```{r}
a1 <- sum(table(ST_clustering_1$age))
a2 <- sum(table(ST_clustering_2$age))
a3 <- sum(table(ST_clustering_3$age))

min_cell <- min(a1, a2, a3)
min_cell
rm(a1, a2, a3)
```


### Select random subsets of the same size

To 2649 spots (same size as the smallest age group, i.e., age1).

```{r}
set.seed(1) ; age1 <- ST_clustering_1[, sample(colnames(ST_clustering_1), size = min_cell)]
set.seed(1) ; age2 <- ST_clustering_2[, sample(colnames(ST_clustering_2), size = min_cell)]
set.seed(1) ; age3 <- ST_clustering_3[, sample(colnames(ST_clustering_3), size = min_cell)]


a1 <- sum(table(age1$age))
a2 <- sum(table(age2$age))
a3 <- sum(table(age3$age))

a1
a2
a3

gc()
```

```{r}
p1 <- DimPlot(age1, reduction = "umap")
p2 <- DimPlot(age2, reduction = "umap")
p3 <- DimPlot(age3, reduction = "umap")
```

```{r}
p <- p1|p2|p3
p
```

```{r}
pdf(file = paste0(myfolder, "ST_temporal_umap_age_1.pdf"), width = 15, height = 15, bg = "transparent")
p1
dev.off()

pdf(file = paste0(myfolder, "ST_temporal_umap_age_2.pdf"), width = 15, height = 15, bg = "transparent")
p2
dev.off()

pdf(file = paste0(myfolder, "ST_temporal_umap_age_3.pdf"), width = 15, height = 15, bg = "transparent")
p3
dev.off()
```


### Batch effect (embedding by sample)

### Re-order sample by setting factors

```{r}
ST_clustering$sample_id <- factor(ST_clustering$sample_id, levels = c("section_1", "section_2", "section_3",  "section_4",  "section_5",  "section_6",  "section_7",  "section_8",  "section_10", "section_11", "section_24", "section_28", "section_29", "section_31", "section_32", "section_33", "section_34"))

ST_clustering$age <- factor(ST_clustering$age, levels = c("w6", "w7", "w8",  "w9",  "w10",  "w10.5",  "w12"))
```

```{r}
pdf(file = paste0(myfolder, "ST_umap_allspots_sample_id.pdf"), width = 15, height = 15, bg = "transparent")
DimPlot(ST_clustering, reduction = "umap", group.by = "sample_id")
dev.off()

pdf(file = paste0(myfolder, "ST_umap_allspots_age.pdf"), width = 15, height = 15, bg = "transparent")
DimPlot(ST_clustering, reduction = "umap", group.by = "age")
dev.off()
```


```{r}
pdf(file = paste0(myfolder, "ST_umap_allspots_sample_id_age_1.pdf"), width = 15, height = 15, bg = "transparent")
DimPlot(age1, reduction = "umap", group.by = "sample_id")
dev.off()

pdf(file = paste0(myfolder, "ST_umap_allspots_sample_id_age_2.pdf"), width = 15, height = 15, bg = "transparent")
DimPlot(age2, reduction = "umap", group.by = "sample_id")
dev.off()

pdf(file = paste0(myfolder, "ST_umap_allspots_sample_id_age_3.pdf"), width = 15, height = 15, bg = "transparent")
DimPlot(age3, reduction = "umap", group.by = "sample_id")
dev.off()

```




================================================================================
================================================================================
================================================================================
================================================================================
================================================================================






