---
title: "ST_HDCA_heart_ST_QC_plots"
author: "Raphaël Mauron"
output: html_document
editor_options: 
  chunk_output_type: console
---

# HDCA heart ST Quality plots

This script presents the quality plots performed for this analysis.

NOTE: The path to load the data and the path to save the figures should be changed at your convenience.

Environment: **Conda: r-semla**

## Set up and loading material

### Knit setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### Load library

```{r}
library(semla)
library(tidyr)
library(RcppML)
library(ggplot2)
library(openxlsx)
```


### Set working directory

```{r}
myfolder <- "~/hdca_DevHeart/output/HDCA_heart_sc_analysis_docker/complementary/ST/"
```


### Load `Seurat` object with ST data

```{r}
ST <- readRDS("~/hdca_DevHeart/data/ST/220114_STdata_harmony_semla.rds")
ST_clustering <- readRDS("~/hdca_DevHeart/data/ST/HDCA_heart_clustering.rds")
```


### Update image paths

```{r}
image_files <- list.files(path = "~/hdca_DevHeart/data/ST", 
                          pattern = "tissue_hires_image.png", 
                          full.names = TRUE, 
                          recursive = TRUE)
ST@tools$Staffli@imgs <- image_files
```


### Load H&E images

```{r}
ST <- LoadImages(ST, image_height = 1.5e3)
```


### Add section ID's to the ST object

```{r}
ST$sample_id <- paste0("section_", GetCoordinates(ST)$sampleID)
```


## Age specific cell type co-localization

```{r}
ST_meta_data <- openxlsx::read.xlsx("~/hdca_DevHeart/data/ST/HDCA_heart_ST_sections_overview_chambers_present.xlsx")
ST_meta_data$age <- as.numeric(gsub("[^0-9.]", "", ST_meta_data$Age))

ST_meta_data <- select(ST_meta_data, Section, age)
ST_meta_data$sample_id <- paste0("section_", ST_meta_data$Section)
ST_meta_data
```


### Re-order sample by setting factors

```{r}
ST$sample_id <- factor(ST$sample_id, levels = unique(ST_meta_data$sample_id))
```


## Table QC metrics

```{r}
# Extract metadata 
ST_meta <- ST@meta.data

# Create dataframe for avg nCount and nFeature
QC_metrics <- data.frame(matrix(ncol = 3, nrow = 0))

for (section in unique(ST_meta$sample_id)) {
  sec <- ST_meta[ST_meta$sample_id == section, ]
  nCount <- as.character(ave(sec$nCount_Spatial)[1])
  nFeature <- as.character(ave(sec$nFeature_Spatial)[1])
  name <- as.character(sec$sample_id[1])
  
  l <- c(name, nCount, nFeature)
  QC_metrics <- rbind(QC_metrics, l)
}

# Set column names
col_names <- c("SectionID", "avg_nCount", "avg_nFeature")
colnames(QC_metrics) <- col_names

# Export 
openxlsx::write.xlsx(QC_metrics, file = paste0(myfolder, "QC_metrics.xlsx"))

rm(sec, col_names, l, name, nCount, nFeature, section)
gc()
```



## Plot section with H&E image - QC ST

### Set default assay to `Spatial´

```{r}
DefaultAssay(ST) <- "Spatial"
```


### Check clusters name - example

```{r}
head(rownames(ST), 10)
```


### Plot MapFeatures nCount - nFeature for 4 sections of interest

#### nCount

##### section 5

```{r fig.asp=0.7}
pdf(file = paste0(myfolder, "nCount_section_5.pdf"), width = 5, height = 5)
MapFeatures(ST,
            features = "nCount_Spatial",
            section_number = 5,
            #override_plot_dims = T,
            colors = c("white", "red", "black"),
            pt_size = 1.6) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()
dev.off()
```


##### section 2

```{r fig.asp=0.7}
pdf(file = paste0(myfolder, "nCount_section_2.pdf"), width = 5, height = 5)
MapFeatures(ST,
            features = "nCount_Spatial",
            section_number = 2,
            #override_plot_dims = T,
            colors = c("white", "red", "black"),
            pt_size = 1.6) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()
dev.off()
```


##### section 11

```{r fig.asp=0.7}
pdf(file = paste0(myfolder, "nCount_section_11.pdf"), width = 5, height = 5)
MapFeatures(ST,
            features = "nCount_Spatial",
            section_number = 11,
            #override_plot_dims = T,
            colors = c("white", "red", "black"),
            pt_size = 1.6) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()
dev.off()
```


##### section 24

```{r fig.asp=0.7}
pdf(file = paste0(myfolder, "nCount_section_24.pdf"), width = 5, height = 5)
MapFeatures(ST,
            features = "nCount_Spatial",
            section_number = 24,
            #override_plot_dims = T,
            colors = c("white", "red", "black"),
            pt_size = 1.6) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()
dev.off()
```


##### section 5, 2, 11, 24 (Extended Fig. 1D)

```{r fig.asp=0.7}
plots <- MapFeatures(ST,
            features = "nCount_Spatial",
            override_plot_dims = TRUE,
            colors = c("white", "red", "black"),
            pt_size = 1.6) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()

p5 <- plots[[5]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p2 <- plots[[2]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p11 <- plots[[11]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p24 <- plots[[24]] & theme(plot.subtitle = element_blank(), legend.position = "right", legend.text = element_text(angle = 0))


p <- p5 + p2 + p11 + p24  +
  patchwork::plot_layout(ncol = 4) 

pdf(file = paste0(myfolder, "nCount_section_5_2_11_24.pdf"), width = 15.75, height = 4.5)
p
dev.off()
```


#### nFeature

##### section 5

```{r fig.asp=0.7}
pdf(file = paste0(myfolder, "nFeature_section_5.pdf"), width = 5, height = 5)
MapFeatures(ST,
            features = "nFeature_Spatial",
            section_number = 5,
            #override_plot_dims = T,
            colors = c("white", "red", "black"),
            pt_size = 1.6) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()
dev.off()
```


##### section 2

```{r fig.asp=0.7}
pdf(file = paste0(myfolder, "nFeature_section_2.pdf"), width = 5, height = 5)
MapFeatures(ST,
            features = "nFeature_Spatial",
            section_number = 2,
            #override_plot_dims = T,
            colors = c("white", "red", "black"),
            pt_size = 1.6) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()
dev.off()
```


##### section 11

```{r fig.asp=0.7}
pdf(file = paste0(myfolder, "nFeature_section_11.pdf"), width = 5, height = 5)
MapFeatures(ST,
            features = "nFeature_Spatial",
            section_number = 11,
            #override_plot_dims = T,
            colors = c("white", "red", "black"),
            pt_size = 1.6) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()
dev.off()
```


##### section 24

```{r fig.asp=0.7}
pdf(file = paste0(myfolder, "nFeature_section_24.pdf"), width = 5, height = 5)
MapFeatures(ST,
            features = "nFeature_Spatial",
            section_number = 24,
            #override_plot_dims = T,
            colors = c("white", "red", "black"),
            pt_size = 1.6) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()
dev.off()
```


##### section 5, 2, 11, 24 (Extended Fig. 1D)

```{r fig.asp=0.7}
plots <- MapFeatures(ST,
            features = "nFeature_Spatial",
            override_plot_dims = TRUE,
            colors = c("white", "red", "black"),
            pt_size = 1.6) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()

p5 <- plots[[5]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p2 <- plots[[2]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p11 <- plots[[11]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p24 <- plots[[24]] & theme(plot.subtitle = element_blank(), legend.position = "right", legend.text = element_text(angle = 0))


p <- p5 + p2 + p11 + p24  +
  patchwork::plot_layout(ncol = 4) 

pdf(file = paste0(myfolder, "nFeature_section_5_2_11_24.pdf"), width = 15.75, height = 4.5)
p
dev.off()
```


#### MapFeaturesSummary + violin (every section)

```{r}
jpeg(filename = paste0(myfolder, "/QC_nFeatures_ST.jpg"), width = 4000, height = 4000, res = 150)
MapFeaturesSummary(ST, 
                   features = "nFeature_Spatial", 
                   subplot_type = "violin")
dev.off()
```


#### Subset of section - nCount_Spatial

```{r}
p <- MapFeatures(ST,
                 features = "nCount_Spatial",
                 override_plot_dims = TRUE,
                 colors = c("white", "red", "black"),
                 max_cutoff = 0.99, #flattened the expression above 0.99 percentile
                 pt_size = 1.6)

p5 <- p[[5]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p2 <- p[[2]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p11 <- p[[11]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p24 <- p[[24]] & theme(plot.subtitle = element_blank(), legend.position = "right", legend.text = element_text(angle = 0))


pg <- p5 + p2 + p11 + p24  +
  patchwork::plot_layout(ncol = 4)


pdf(file = paste0(myfolder, "nCount_section_5_2_11_24_cutoff_099.pdf"), width = 15.75, height = 4.5)
print(pg)
dev.off()
rm(p, p2, p5, p11, p24, pg)
```


#### Subset of section - nFeature_Spatial

```{r}
p <- MapFeatures(ST,
                 features = "nFeature_Spatial",
                 override_plot_dims = TRUE,
                 colors = c("white", "red", "black"),
                 max_cutoff = 0.99, #flattened the expression above 0.99 percentile
                 pt_size = 1.6)

p5 <- p[[5]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p2 <- p[[2]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p11 <- p[[11]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p24 <- p[[24]] & theme(plot.subtitle = element_blank(), legend.position = "right", legend.text = element_text(angle = 0))


pg <- p5 + p2 + p11 + p24  +
  patchwork::plot_layout(ncol = 4)


pdf(file = paste0(myfolder, "nFeature_section_5_2_11_24_cutoff_099.pdf"), width = 15.75, height = 4.5)
print(pg)
dev.off()
rm(p, p2, p5, p11, p24, pg)
```


### Plot gender marker accross every sections

#### UTY

```{r fig.asp=0.7}
jpeg(filename = paste0(myfolder, "/UTY.jpg"), width = 4000, height = 4000, res = 150)
MapFeatures(ST,
            features = "UTY",
            override_plot_dims = T,
            colors = c("lightgrey","mistyrose", "red", "darkred", "black"),
            pt_size = 1.6) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()
dev.off()
```


#### ZFY

```{r fig.asp=0.7}
jpeg(filename = paste0(myfolder, "/ZFY.jpg"), width = 4000, height = 4000, res = 150)
MapFeatures(ST,
            features = "ZFY",
            override_plot_dims = T,
            colors = c("lightgrey","mistyrose", "red", "darkred", "black"),
            pt_size = 1.6) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()
dev.off()
```


#### KDM5D (Extended Fig. 1B)

```{r fig.asp=0.7}
jpeg(filename = paste0(myfolder, "/KDM5D.jpg"), width = 4000, height = 4000, res = 150)
MapFeatures(ST,
            features = "KDM5D",
            override_plot_dims = T,
            colors = c("lightgrey","mistyrose", "red", "darkred", "black"),
            pt_size = 1.6) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()
dev.off()
```


#### USP9Y

```{r fig.asp=0.7}
jpeg(filename = paste0(myfolder, "/USP9Y_Spatial.jpg"), width = 4000, height = 4000, res = 150)
MapFeatures(ST,
            features = "USP9Y",
            override_plot_dims = T,
            colors = c("lightgrey","mistyrose", "red", "darkred", "black"),
            pt_size = 1.6) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()
dev.off()
```


## Extra MapFeatures - temporal
FeaturePlot on section 5, 2, 11, 24 for the following genes: MYH7, MYH6, ELN and TNFRSF19

### Set default assay to `SCT´

```{r}
DefaultAssay(ST) <- "SCT"
```

### MYH7

```{r}
p <- MapFeatures(ST,
                 features = "MYH7",
                 override_plot_dims = TRUE,
                 colors = c("white", "red", "black"),
                 max_cutoff = 0.99, #flattened the expression above 0.99 percentile
                 pt_size = 1.5)

p5 <- p[[5]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p2 <- p[[2]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p11 <- p[[11]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p24 <- p[[24]] & theme(plot.subtitle = element_blank(), legend.position = "right", legend.text = element_text(angle = 0))


pg <- p5 + p2 + p11 + p24  +
  patchwork::plot_layout(ncol = 4) 


pdf(file = paste0(myfolder, "MYH7_subset_section.pdf"), width = 15.75, height = 4.5)
print(pg)
dev.off()
rm(p, p2, p5, p11, p24, pg)
```


### MYH6

```{r}
p <- MapFeatures(ST,
                 features = "MYH6",
                 override_plot_dims = TRUE,
                 colors = c("white", "red", "black"),
                 max_cutoff = 0.99, #flattened the expression above 0.99 percentile
                 pt_size = 1.5)

p5 <- p[[5]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p2 <- p[[2]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p11 <- p[[11]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p24 <- p[[24]] & theme(plot.subtitle = element_blank(), legend.position = "right", legend.text = element_text(angle = 0))


pg <- p5 + p2 + p11 + p24  +
  patchwork::plot_layout(ncol = 4) 


pdf(file = paste0(myfolder, "MYH6_subset_section.pdf"), width = 15.75, height = 4.5)
print(pg)
dev.off()
rm(p, p2, p5, p11, p24, pg)
```


### ELN

```{r}
p <- MapFeatures(ST,
                 features = "ELN",
                 override_plot_dims = TRUE,
                 colors = c("white", "red", "black"),
                 max_cutoff = 0.99, #flattened the expression above 0.99 percentile
                 pt_size = 1.5)

p5 <- p[[5]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p2 <- p[[2]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p11 <- p[[11]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p24 <- p[[24]] & theme(plot.subtitle = element_blank(), legend.position = "right", legend.text = element_text(angle = 0))


pg <- p5 + p2 + p11 + p24  +
  patchwork::plot_layout(ncol = 4) 


pdf(file = paste0(myfolder, "ELN_subset_section.pdf"), width = 15.75, height = 4.5)
print(pg)
dev.off()
rm(p, p2, p5, p11, p24, pg)
```


### TNFRSF19

```{r}
p <- MapFeatures(ST,
                 features = "TNFRSF19",
                 override_plot_dims = TRUE,
                 colors = c("white", "red", "black"),
                 max_cutoff = 0.99, #flattened the expression above 0.99 percentile
                 pt_size = 1.5)

p5 <- p[[5]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p2 <- p[[2]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p11 <- p[[11]] & theme(plot.subtitle = element_blank(), legend.position = "none")
p24 <- p[[24]] & theme(plot.subtitle = element_blank(), legend.position = "right", legend.text = element_text(angle = 0))


pg <- p5 + p2 + p11 + p24  +
  patchwork::plot_layout(ncol = 4) 


pdf(file = paste0(myfolder, "TNFRSF19_subset_section.pdf"), width = 15.75, height = 4.5)
print(pg)
dev.off()
rm(p, p2, p5, p11, p24, pg)
```


## Violin plots (Extended Fig. 1C)

### nCount

```{r}
pdf(paste0(myfolder, "/QC_Violin_nCount_ST.pdf"), width = 16, height = 5)
VlnPlot(ST, features = "nCount_Spatial", group.by = "sample_id", pt.size = 0.1) + NoLegend() + theme(axis.text.x = element_text(size = 20),
                                                                                                     axis.text.y = element_text(size = 20))
dev.off()

pdf(paste0(myfolder, "/QC_Violin_nCount_ST_no_point.pdf"), width = 16, height = 5)
VlnPlot(ST, features = "nCount_Spatial", group.by = "sample_id", pt.size = 0) + NoLegend() + theme(axis.text.x = element_text(size = 20),
                                                                                                     axis.text.y = element_text(size = 20))
dev.off()
```

### nFeature

```{r}
pdf(paste0(myfolder, "/QC_Violin_nFeature_ST.pdf"), width = 16, height = 5)
VlnPlot(ST, features = "nFeature_Spatial", group.by = "sample_id", pt.size = 0.1) + NoLegend() + theme(axis.text.x = element_text(size = 20),
                                                                                                     axis.text.y = element_text(size = 20))
dev.off()

pdf(paste0(myfolder, "/QC_Violin_nFeature_ST_no_point.pdf"), width = 16, height = 5)
VlnPlot(ST, features = "nFeature_Spatial", group.by = "sample_id", pt.size = 0) + NoLegend() + theme(axis.text.x = element_text(size = 20),
                                                                                                     axis.text.y = element_text(size = 20))
dev.off()
```


### KDM5D

```{r}
pdf(paste0(myfolder, "/QC_Violin_KDM5D_ST_no_point.pdf"), width = 16, height = 5)
VlnPlot(ST, features = "KDM5D", group.by = "sample_id", pt.size = 0) + NoLegend() + theme(axis.text.x = element_text(size = 20),
                                                                                                     axis.text.y = element_text(size = 20))
dev.off()
```


### USP9Y

```{r}
pdf(paste0(myfolder, "/QC_Violin_USP9Y_ST_no_point.pdf"), width = 16, height = 5)
VlnPlot(ST, features = "USP9Y", group.by = "sample_id", pt.size = 0) + NoLegend() + theme(axis.text.x = element_text(size = 20),
                                                                                                     axis.text.y = element_text(size = 20))
dev.off()
```


### UTY

```{r}
pdf(paste0(myfolder, "/QC_Violin_UTY_ST_no_point.pdf"), width = 16, height = 5)
VlnPlot(ST, features = "UTY", group.by = "sample_id", pt.size = 0) + NoLegend() + theme(axis.text.x = element_text(size = 20),
                                                                                                     axis.text.y = element_text(size = 20))
dev.off()
```


### ZFY

```{r}
pdf(paste0(myfolder, "/QC_Violin_ZFY_ST_no_point.pdf"), width = 16, height = 5)
VlnPlot(ST, features = "ZFY", group.by = "sample_id", pt.size = 0) + NoLegend() + theme(axis.text.x = element_text(size = 20),
                                                                                                     axis.text.y = element_text(size = 20))
dev.off()
```


## Spatial Clustering

### All 17 kept sections

```{r}
pdf(file = paste0(myfolder, "ST_umap_allspots.pdf"), width = 15, height = 15, bg = "transparent")
DimPlot(ST_clustering, reduction = "umap")
dev.off()
```


### Temporal UMAP

```{r}
table(ST_clustering$age)
```

```{r}
ST_clustering_1 <- ST_clustering[, ST_clustering$age %in% c("w6", "w7")]
ST_clustering_2 <- ST_clustering[, ST_clustering$age %in% c("w8", "w9")]
ST_clustering_3 <- ST_clustering[, ST_clustering$age %in% c("w10", "w10.5", "w12")]
```

```{r}
table(ST_clustering_1$age)
table(ST_clustering_2$age)
table(ST_clustering_3$age)
```


#### Check cell group (age) with the fewest cells

```{r}
a1 <- sum(table(ST_clustering_1$age))
a2 <- sum(table(ST_clustering_2$age))
a3 <- sum(table(ST_clustering_3$age))

min_cell <- min(a1, a2, a3)
min_cell
rm(a1, a2, a3)
```


### Select random subsets of the same size

To 2649 spots (same size as the smallest age group, i.e., age1).

```{r}
set.seed(1) ; age1 <- ST_clustering_1[, sample(colnames(ST_clustering_1), size = min_cell)]
set.seed(1) ; age2 <- ST_clustering_2[, sample(colnames(ST_clustering_2), size = min_cell)]
set.seed(1) ; age3 <- ST_clustering_3[, sample(colnames(ST_clustering_3), size = min_cell)]


a1 <- sum(table(age1$age))
a2 <- sum(table(age2$age))
a3 <- sum(table(age3$age))

a1
a2
a3

gc()
```

```{r}
p1 <- DimPlot(age1, reduction = "umap")
p2 <- DimPlot(age2, reduction = "umap")
p3 <- DimPlot(age3, reduction = "umap")
```

```{r}
p <- p1|p2|p3
p
```

```{r}
pdf(file = paste0(myfolder, "ST_temporal_umap_age_1.pdf"), width = 15, height = 15, bg = "transparent")
p1
dev.off()

pdf(file = paste0(myfolder, "ST_temporal_umap_age_2.pdf"), width = 15, height = 15, bg = "transparent")
p2
dev.off()

pdf(file = paste0(myfolder, "ST_temporal_umap_age_3.pdf"), width = 15, height = 15, bg = "transparent")
p3
dev.off()
```


================================================================================
================================================================================
================================================================================
================================================================================
================================================================================






