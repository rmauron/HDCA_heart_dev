---
title: "ST_HDCA_spatial_CCC"
author: "RaphaÃ«l Mauron"
output: html_document
editor_options: 
  chunk_output_type: console
---

# HDCA heart ST spatial ccc

We calculate spatial CCC, or Ligand-Receptor representation.

NOTE: The path to load the data and the path to save the figures should be changed at your convenience.

Environment: **Conda: r-semla**

## Set up and loading material

### Knit setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### Load library

```{r}
library(semla)
library(tidyr)
library(RcppML)
library(ggplot2)
library(openxlsx)
library(RcppML)
library(singlet)
library(tidyverse)
library(viridis)
library(pheatmap)
library(tibble)
library(colorjam)
library(patchwork)
library(plotly)
library(kableExtra)
```


### Set working directory

```{r}
myfolder <- "~/hdca_DevHeart/output/HDCA_heart_sc_analysis_docker/ST_spatial_ccc/"
```


### Load custom function

```{r}
source("~/Documents/GitHub/semla_training/CellColoc.R")
```


### Load `Seurat` object with ST data

```{r}
ST <- readRDS("~/hdca_DevHeart/data/ST/220114_STdata_harmony_semla.rds")
ST_clustering <- readRDS("~/hdca_DevHeart/data/ST/HDCA_heart_clustering.rds")
```


### Update image paths

```{r}
image_files <- list.files(path = "~/hdca_DevHeart/data/ST", 
                          pattern = "tissue_hires_image.png", 
                          full.names = TRUE, 
                          recursive = TRUE)
ST@tools$Staffli@imgs <- image_files
```


### Load H&E images

```{r}
ST <- LoadImages(ST, image_height = 1.5e3)
```


### Add section ID's to the ST object

```{r}
ST$sample_id <- paste0("section_", GetCoordinates(ST)$sampleID)
```


## Age specific cell type co-localization

```{r}
ST_meta_data <- openxlsx::read.xlsx("~/hdca_DevHeart/data/ST/HDCA_heart_ST_sections_overview_chambers_present.xlsx")
ST_meta_data$age <- as.numeric(gsub("[^0-9.]", "", ST_meta_data$Age))

ST_meta_data <- select(ST_meta_data, Section, age)
ST_meta_data$sample_id <- paste0("section_", ST_meta_data$Section)

ST_meta_data$age_groups <- cut(
  ST_meta_data$age,
  breaks = c(-Inf, 8, 10, Inf),
  labels = c("w6-w7", "w8-w9", "w10-w12"),
  right = FALSE
)

ST_meta_data
```


### Re-order sample by setting factors

```{r}
ST$sample_id <- factor(ST$sample_id, levels = unique(ST_meta_data$sample_id))
```


## Spatial CCC (Extended Fig. 2E)

```{r}
DefaultAssay(ST) <- "SCT"
MapFeatures(ST,
            features = "MYH6",
            slot = "data", #data
            pt_size = 1) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()
```


```{r}
# parameters
ligand_receptor_pairs <- list(
  c("NPPA", "NPR1"),
  c("NPPA", "NPR3"),
  c("NPPB", "NPR1"),
  c("NPPB", "NPR2"),
  c("NPPB", "NPR3"),
  c("NPPC", "NPR2"),
  c("NPPC", "NPR3"),
  c("OSTN", "NPR3"),
  c("SEMA3C", "PLXNA2"),
  c("SEMA3C", "PLXNA4"),
  c("SEMA3D", "PLXNA2"),
  c("SEMA3D", "PLXNA4"),
  c("SEMA6A", "PLXNA2"),
  c("SEMA6A", "PLXNA4"),
  c("SEMA6B", "PLXNA2"),
  c("SEMA6B", "PLXNA4"),
  c("SEMA3A", "PLXNA4"),
  c("SEMA3A", "NRP1"))
section_number_list <- c(5, 8, 2, 11, 24)
object <- ST
pt_size <- 1

#loop through all the pairs and all the section required
for (features in ligand_receptor_pairs) {
  print(features)
  for (section_number in section_number_list) {
    print(section_number)
  
    plts <- Spatial_LR(object = ST, features = features, section_number = section_number)
    
    pdf(file = paste0(myfolder, features[1], "_", features[2], "_section_", section_number, ".pdf"), width = 6, height = 6)
    print(plts)
    dev.off()
  }
}
```


```{r}
# parameters
ligand_receptor_pairs <- list(
  c("NOTCH3", "JAG1"))
section_number_list <- c(1, 9, 12, 20)
object <- ST
pt_size <- 1

#loop through all the pairs and all the section required
for (features in ligand_receptor_pairs) {
  print(features)
  for (section_number in section_number_list) {
    print(section_number)
  
    plts <- Spatial_LR(object = ST, features = features, section_number = section_number)
    
    pdf(file = paste0(myfolder, features[1], "_", features[2], "_section_", section_number, ".pdf"), width = 6, height = 6)
    print(plts)
    dev.off()
  }
}
```


### Plot all sections (1 patchwork per cluster)
Here we project the gene expression of cluster individually on every section

```{r}
LR_list <- c("NPPA", "NPPB", "NPPC", "NPR1", "NPR2", "NPR3")
section_number_list <- c(5, 8)

for (marker in LR_list) {
  for (section_number in section_number_list) {
    p <- MapFeatures(ST,
                     features = marker,
                     colors = viridis::turbo(n = 11),
                     slot = "data",
                     section_number = section_number,
                     pt_size = 1) +
      ThemeLegendRight()
    
    pdf(file = paste0(myfolder, "marker_2_", marker, "_section_", section_number, ".pdf"), width = 4, height = 4)
    print(p)
    dev.off()
  }
}
rm(p)
```


```{r}
# parameters
ligand_receptor_pairs <- list(
  c("NPPA", "NPPA"),
  c("NPPB", "NPPB"),
  c("NPPC", "NPPC"),
  c("NPR1", "NPR1"),
  c("NPR2", "NPR2"),
  c("NPR3", "NPR3"))

section_number_list <- c(5, 8, 2, 11, 24)
object <- ST
pt_size <- 1

#loop through all the pairs and all the section required
for (features in ligand_receptor_pairs) {
  print(features)
  for (section_number in section_number_list) {
    print(section_number)
  
    plts <- Spatial_LR_same(object = ST, features = features, section_number = section_number)
    
    pdf(file = paste0(myfolder, "marker_", features[1], "_section_", section_number, ".pdf"), width = 6, height = 6)
    print(plts)
    dev.off()
  }
}
```



### FeaturePlots (Extended Fig. 6B, 6C)

```{r}
# Create path if not existing
if (!dir.exists(paste0(myfolder, "featureplot"))){
  dir.create(paste0(myfolder, "featureplot"), recursive = TRUE)}

for (feature in c("FOXP2", "LRP1B", "FLRT2", "DLK1", "PI15", "PRDM6", "EFNA5")) {
  p <- MapFeatures(ST,
                   features = feature,
                   override_plot_dims = TRUE,
                   colors = c("lightgrey","mistyrose", "red", "darkred", "black"),
                   pt_size = 1.5)
  
  p5 <- p[[5]] & theme(plot.subtitle = element_blank(), legend.position = "none")
  p32 <- p[[32]] & theme(plot.subtitle = element_blank(), legend.position = "none")
  p11 <- p[[11]] & theme(plot.subtitle = element_blank(), legend.position = "right", legend.text = element_text(angle = 0))

  pg <- p5 + p32 + p11 +
    patchwork::plot_layout(ncol = 3)
  
  pdf(file = paste0(myfolder, "featureplot/", feature, ".pdf"), width = 15.75, height = 4.5)
  print(pg)
  dev.off()
}
rm(p, p32, p5, p11, pg)
```


```{r}
# Create path if not existing
if (!dir.exists(paste0(myfolder, "featureplot"))){
  dir.create(paste0(myfolder, "featureplot"), recursive = TRUE)}

for (feature in c("SEMA3D", "FMOD", "COL12A1", "ADAMTS19")) {
  p <- MapFeatures(ST,
                   features = feature,
                   override_plot_dims = TRUE,
                   colors = c("lightgrey","mistyrose", "red", "darkred", "black"),
                   pt_size = 1.5)
  
  p5 <- p[[5]] & theme(plot.subtitle = element_blank(), legend.position = "none")
  p20 <- p[[20]] & theme(plot.subtitle = element_blank(), legend.position = "right", legend.text = element_text(angle = 0))

  pg <- p5 + p20 +
    patchwork::plot_layout(ncol = 2)
  
  pdf(file = paste0(myfolder, "featureplot/", feature, ".pdf"), width = 15.75, height = 4.5)
  print(pg)
  dev.off()
}
rm(p, p5, p20, pg)
```


```{r}
# Create path if not existing
if (!dir.exists(paste0(myfolder, "featureplot"))){
  dir.create(paste0(myfolder, "featureplot"), recursive = TRUE)}

for (feature in c("CD34")) {
  p <- MapFeatures(ST,
                   features = feature,
                   override_plot_dims = TRUE,
                   colors = c("lightgrey","mistyrose", "red", "darkred", "black"),
                   pt_size = 1.5)
  
  p5 <- p[[5]] & theme(plot.subtitle = element_blank(), legend.position = "none")
  p2 <- p[[2]] & theme(plot.subtitle = element_blank(), legend.position = "none")
  p11 <- p[[11]] & theme(plot.subtitle = element_blank(), legend.position = "none")
  p24 <- p[[24]] & theme(plot.subtitle = element_blank(), legend.position = "right", legend.text = element_text(angle = 0))

  pg <- p5 + p2 + p11 + p24 +
    patchwork::plot_layout(ncol = 4)
  
  pdf(file = paste0(myfolder, "featureplot/", feature, ".pdf"), width = 15.75, height = 4.5)
  print(pg)
  dev.off()
}
rm(p, p5, p2, p11, p24, pg)
```


================================================================================
================================================================================
================================================================================
================================================================================
================================================================================










