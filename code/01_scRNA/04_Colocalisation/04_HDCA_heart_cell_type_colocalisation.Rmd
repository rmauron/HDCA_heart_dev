---
title: "04_HDCA_heart_cell_type_colocalisation"
author: "Raphaël Mauron"
output: html_document
editor_options: 
  chunk_output_type: console
---

# HDCA heart cell type colocalisation

A specific environment as been created to run this script. The reason being we are using the package called ´semla´ (https://github.com/ludvigla/semla) which has dependencies and was not installed at the beginning of the overall analysis.
To avoid any dependencies issues, it has been decided to run this code separately.

NOTE: The path to load the data and the path to save the figures should be changed at your convenience.

Environment: **Conda: r-semla**


## Set up and loading material

### Knit setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### Load library

```{r}
library(semla)
library(dplyr)
library(colorjam)
library(pheatmap)
library(igraph)
library(patchwork)
```


### Load custom function

```{r}
source("~/Documents/GitHub/semla_training/CellColoc.R")
```


### Set working directory

```{r}
myfolder <- "~/hdca_DevHeart/output/HDCA_heart_sc_analysis_docker/stereoscope/visualization/colocalization/"
```


### Load ST data

```{r}
ST <- readRDS("~/hdca_DevHeart/data/ST/220114_STdata_harmony_semla.rds")
```


### Add sectionID

```{r}
ST$sectionID <- GetCoordinates(ST)$sampleID
```


================================================================================
================================================================================

## Cell type co-localization

### High Level

#### Load stereoscope data and add as separate assay

```{r}
proportions <- read.table("~/hdca_DevHeart/data/ST/stereoscope/W.2023-09-25133054.715121_hl.tsv", header = TRUE, check.names = FALSE)

proportions <- proportions %>% select(-c("6", "34"))

# Check that all spot IDs are matched
all(colnames(ST) == rownames(proportions))

# Create and store assay
ST[["stereoscope"]] <- CreateAssayObject(data = t(proportions))
```


#### Pairwise correlation

#### Correlation matrix between ST and stereoscope assay

```{r}
corMat <- cor(GetAssayData(ST, assay = "stereoscope", slot = "data") |> t())
dim(corMat)
```


#### Set diagonal to NA

```{r}
diag(corMat) <- NA
```


#### Visualization

```{r}
heatmap_colors <- colorRampPalette(RColorBrewer::brewer.pal(n = 11, name = "RdBu") |> rev())(50)

#pdf(file = paste0(myfolder, "heatmaps/colocalization_hl_all.pdf"), width = 15, height = 15)
pheatmap(corMat, border_color = NA, color = heatmap_colors)
#dev.off()
```


#### Add the annotation

```{r}
annotation <- read.csv2("~/hdca_DevHeart/data/metadata/hl_annotation_2023-08-23.csv", header = 1, sep = ";")

annotation$cluster <- gsub("_", "-", annotation$cluster)

cells_clusters <- setNames(annotation$cell_type, nm = annotation$cluster)
```


#### Better control of the Heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- colnames(corMat)[clusters$order] # Fetch rearranged cell type labels

# Pivot corMat to long data format
cors <- tidyr::pivot_longer(corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_hl_all.pdf"), width = 15, height = 15)
p
dev.off()
```


#### Better control of the Heatmap with ggplot2 (re-organize annotations) - delete?

```{r}
# Cluster data for arrangement
distMat <- dist(corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- colnames(corMat)[clusters$order] # Fetch rearranged cell type labels

# Pivot corMat to long data format
cors <- tidyr::pivot_longer(corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

cors$celltype_names <- cells_clusters[as.character(cors$celltype)]
cors$name_names <- cells_clusters[as.character(cors$name)]

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype_names, y = name_names, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_hl_all_celltype_names.pdf"), width = 15, height = 15)
p
dev.off()
```


#### Set default assay to `stereoscope´

```{r}
DefaultAssay(ST) <- "stereoscope"
```


### Cell type co-localization (age specific)

```{r}
ST_meta_data <- openxlsx::read.xlsx("~/hdca_DevHeart/data/ST/HDCA_heart_ST_sections_overview_chambers_present.xlsx")
ST_meta_data$age <- as.numeric(gsub("[^0-9.]", "", ST_meta_data$Age))

ST_meta_data <- select(ST_meta_data, Section, age)
ST_meta_data
```


#### Annotate section with corresponding age

```{r}
section_age <- setNames(ST_meta_data$age, nm = ST_meta_data$Section)
ST$age <- section_age[as.character(ST$sectionID)]
```


#### Creating age groups

```{r}
ST_age1 <- ST[,ST$age <= 7.5]
ST_age2 <- ST[,ST$age == 8 | ST$age == 9]
ST_age3 <- ST[,ST$age >= 10]
```


##### Sanity check

```{r}
table(ST_age1$age)
table(ST_age2$age)
table(ST_age3$age)
```


### ST_age1 - Pairwise correlation

#### Correlation matrix between ST and stereoscope assay

```{r}
corMat <- cor(GetAssayData(ST_age1, assay = "stereoscope", slot = "data") |> t())
dim(corMat)
```


#### Set diagonal to NA

```{r}
diag(corMat) <- NA
```


#### Visualization

```{r}
heatmap_colors <- colorRampPalette(RColorBrewer::brewer.pal(n = 11, name = "RdBu") |> rev())(50)

pheatmap(corMat, border_color = NA, color = heatmap_colors)
```


#### Better control of the Heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- colnames(corMat)[clusters$order] # Fetch rearranged cell type labels

# Pivot corMat to long data format
cors <- tidyr::pivot_longer(corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank()) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_hl_age1.pdf"), width = 15, height = 15)
p
dev.off()
```


### ST_age2 - Pairwise correlation

#### Correlation matrix between ST and stereoscope assay

```{r}
corMat <- cor(GetAssayData(ST_age2, assay = "stereoscope", slot = "data") |> t())
dim(corMat)
```


#### Set diagonal to NA

```{r}
diag(corMat) <- NA
```


#### Visualization

```{r}
heatmap_colors <- colorRampPalette(RColorBrewer::brewer.pal(n = 11, name = "RdBu") |> rev())(50)

pheatmap(corMat, border_color = NA, color = heatmap_colors)
```


#### Better control of the Heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- colnames(corMat)[clusters$order] # Fetch rearranged cell type labels

# Pivot corMat to long data format
cors <- tidyr::pivot_longer(corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank()) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_hl_age2.pdf"), width = 15, height = 15)
p
dev.off()
```


### ST_age3 - Pairwise correlation

#### Correlation matrix between ST and stereoscope assay

```{r}
corMat <- cor(GetAssayData(ST_age3, assay = "stereoscope", slot = "data") |> t())
dim(corMat)
```


#### Set diagonal to NA

```{r}
diag(corMat) <- NA
```


#### Visualization

```{r}
heatmap_colors <- colorRampPalette(RColorBrewer::brewer.pal(n = 11, name = "RdBu") |> rev())(50)

pheatmap(corMat, border_color = NA, color = heatmap_colors)
```


#### Better control of the Heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- colnames(corMat)[clusters$order] # Fetch rearranged cell type labels

# Pivot corMat to long data format
cors <- tidyr::pivot_longer(corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank()) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_hl_age3.pdf"), width = 15, height = 15)
p
dev.off()
```



### Deep Level

#### Load stereoscope data and add as separate assay

```{r}
proportions <- read.table("~/hdca_DevHeart/data/ST/stereoscope/W.2023-10-28105405.918149_dl.tsv", header = TRUE, check.names = FALSE)

proportions <- proportions %>% select(-c("HL_6", "HL_34"))

# Check that all spot IDs are matched
all(colnames(ST) == rownames(proportions))

# Create and store assay
ST[["stereoscope_dl"]] <- CreateAssayObject(data = t(proportions))
```


#### Pairwise correlation

#### Correlation matrix between ST and stereoscope_dl assay

```{r}
corMat <- cor(GetAssayData(ST, assay = "stereoscope_dl", slot = "data") |> t())
dim(corMat)
```


```{r}
DefaultAssay(ST) <- "stereoscope_dl"
ST
```


#### Set diagonal to NA

```{r}
diag(corMat) <- NA
```


#### Visualization

```{r}
heatmap_colors <- colorRampPalette(RColorBrewer::brewer.pal(n = 11, name = "RdBu") |> rev())(50)

pheatmap(corMat, border_color = NA, color = heatmap_colors)
```


#### Better control of the Heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- colnames(corMat)[clusters$order] # Fetch rearranged cell type labels

# Pivot corMat to long data format
cors <- tidyr::pivot_longer(corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_all.pdf"), width = 30, height = 30)
p
dev.off()
```


### SUBSETS_1: "CM-4-1", "CM-4-2", "EN-1", "EN-12", "CM-18"

```{r}
split_corMat <- corMat[c("CM-4-1", "CM-4-2", "EN-1", "EN-12", "CM-18"), 
                       c("CM-4-1", "CM-4-2", "EN-1", "EN-12", "CM-18")]
pheatmap(split_corMat, border_color = NA, color = heatmap_colors)
```


#### Better control of the Heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(split_corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
#cluster_levels <- colnames(split_corMat)[clusters$order] # Fetch rearranged cell type labels
cluster_levels <- c("CM-4-1", "CM-4-2", "EN-1", "EN-12", "CM-18")

# Pivot split_corMat to long data format
cors <- tidyr::pivot_longer(split_corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(split_corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_subset_1.pdf"), width = 5, height = 4)
p
dev.off()
```


### SUBSETS_2: "CM-19-2", "CM-19-1", "FB-17", "EN-18"

```{r}
split_corMat <- corMat[c("CM-19-2", "CM-19-1", "FB-17", "EN-18"), 
                       c("CM-19-2", "CM-19-1", "FB-17", "EN-18")]
pheatmap(split_corMat, border_color = NA, color = heatmap_colors)
```


#### Better control of the Heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(split_corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
#cluster_levels <- colnames(split_corMat)[clusters$order] # Fetch rearranged cell type labels
cluster_levels <- c("CM-19-2", "CM-19-1", "FB-17", "EN-18")

# Pivot split_corMat to long data format
cors <- tidyr::pivot_longer(split_corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(split_corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_subset_2.pdf"), width = 5, height = 4)
p
dev.off()
```


### SUBSETS_3: "FB-4", "EN-7", "EN-17"

```{r}
split_corMat <- corMat[c("FB-4", "EN-7", "EN-17"), 
                       c("FB-4", "EN-7", "EN-17")]
pheatmap(split_corMat, border_color = NA, color = heatmap_colors)
```


#### Better control of the Heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(split_corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
#cluster_levels <- colnames(split_corMat)[clusters$order] # Fetch rearranged cell type labels
cluster_levels <- c("FB-4", "EN-7", "EN-17")

# Pivot split_corMat to long data format
cors <- tidyr::pivot_longer(split_corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(split_corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_subset_3.pdf"), width = 5, height = 4)
p
dev.off()
```


### Cell type co-localization (age specific)

#### Creating age groups

```{r}
ST_age1 <- ST[,ST$age <= 7.5]
ST_age2 <- ST[,ST$age == 8 | ST$age == 9]
ST_age3 <- ST[,ST$age >= 10]
```


##### Sanity check

```{r}
table(ST_age1$age)
table(ST_age2$age)
table(ST_age3$age)
```


### ST_age1 - Pairwise correlation

#### Correlation matrix between ST and stereoscope assay

```{r}
corMat <- cor(GetAssayData(ST_age1, assay = "stereoscope_dl", slot = "data") |> t())
dim(corMat)
```


#### Set diagonal to NA

```{r}
diag(corMat) <- NA
```


#### Visualization

```{r}
heatmap_colors <- colorRampPalette(RColorBrewer::brewer.pal(n = 11, name = "RdBu") |> rev())(50)

pheatmap(corMat, border_color = NA, color = heatmap_colors)
```


#### Better control of the Heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- colnames(corMat)[clusters$order] # Fetch rearranged cell type labels

# Pivot corMat to long data format
cors <- tidyr::pivot_longer(corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_age1.pdf"), width = 30, height = 30)
p
dev.off()
```


### SUBSETS_1: "CM-4-1", "CM-4-2", "EN-1", "EN-12", "CM-18"

```{r}
split_corMat <- corMat[c("CM-4-1", "CM-4-2", "EN-1", "EN-12", "CM-18"), 
                       c("CM-4-1", "CM-4-2", "EN-1", "EN-12", "CM-18")]
pheatmap(split_corMat, border_color = NA, color = heatmap_colors)
```


#### Better control of the Heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(split_corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
#cluster_levels <- colnames(split_corMat)[clusters$order] # Fetch rearranged cell type labels
cluster_levels <- c("CM-4-1", "CM-4-2", "EN-1", "EN-12", "CM-18")

# Pivot split_corMat to long data format
cors <- tidyr::pivot_longer(split_corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(split_corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_subset_1_age_1.pdf"), width = 5, height = 4)
p
dev.off()
```


### SUBSETS_2: "CM-19-2", "CM-19-1", "FB-17", "EN-18"

```{r}
split_corMat <- corMat[c("CM-19-2", "CM-19-1", "FB-17", "EN-18"), 
                       c("CM-19-2", "CM-19-1", "FB-17", "EN-18")]
pheatmap(split_corMat, border_color = NA, color = heatmap_colors)
```


#### Better control of the Heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(split_corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
#cluster_levels <- colnames(split_corMat)[clusters$order] # Fetch rearranged cell type labels
cluster_levels <- c("CM-19-2", "CM-19-1", "FB-17", "EN-18")

# Pivot split_corMat to long data format
cors <- tidyr::pivot_longer(split_corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(split_corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_subset_2_age_1.pdf"), width = 5, height = 4)
p
dev.off()
```


### SUBSETS_3: "FB-4", "EN-7", "EN-17"

```{r}
split_corMat <- corMat[c("FB-4", "EN-7", "EN-17"), 
                       c("FB-4", "EN-7", "EN-17")]
pheatmap(split_corMat, border_color = NA, color = heatmap_colors)
```


#### Better control of the Heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(split_corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
#cluster_levels <- colnames(split_corMat)[clusters$order] # Fetch rearranged cell type labels
cluster_levels <- c("FB-4", "EN-7", "EN-17")

# Pivot split_corMat to long data format
cors <- tidyr::pivot_longer(split_corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(split_corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_subset_3_age_1.pdf"), width = 5, height = 4)
p
dev.off()
```


### ST_age2 - Pairwise correlation

#### Correlation matrix between ST and stereoscope assay

```{r}
corMat <- cor(GetAssayData(ST_age2, assay = "stereoscope_dl", slot = "data") |> t())
dim(corMat)
```


#### Set diagonal to NA

```{r}
diag(corMat) <- NA
```


#### Visualization

```{r}
heatmap_colors <- colorRampPalette(RColorBrewer::brewer.pal(n = 11, name = "RdBu") |> rev())(50)

pheatmap(corMat, border_color = NA, color = heatmap_colors)
```


#### Better control of the Heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- colnames(corMat)[clusters$order] # Fetch rearranged cell type labels

# Pivot corMat to long data format
cors <- tidyr::pivot_longer(corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_age2.pdf"), width = 30, height = 30)
p
dev.off()
```


### SUBSETS_1: "CM-4-1", "CM-4-2", "EN-1", "EN-12", "CM-18"

```{r}
split_corMat <- corMat[c("CM-4-1", "CM-4-2", "EN-1", "EN-12", "CM-18"), 
                       c("CM-4-1", "CM-4-2", "EN-1", "EN-12", "CM-18")]
pheatmap(split_corMat, border_color = NA, color = heatmap_colors)
```


#### Better control of the Heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(split_corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
#cluster_levels <- colnames(split_corMat)[clusters$order] # Fetch rearranged cell type labels
cluster_levels <- c("CM-4-1", "CM-4-2", "EN-1", "EN-12", "CM-18")

# Pivot split_corMat to long data format
cors <- tidyr::pivot_longer(split_corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(split_corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_subset_1_age_2.pdf"), width = 5, height = 4)
p
dev.off()
```


### SUBSETS_2: "CM-19-2", "CM-19-1", "FB-17", "EN-18"

```{r}
split_corMat <- corMat[c("CM-19-2", "CM-19-1", "FB-17", "EN-18"), 
                       c("CM-19-2", "CM-19-1", "FB-17", "EN-18")]
pheatmap(split_corMat, border_color = NA, color = heatmap_colors)
```


#### Better control of the Heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(split_corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
#cluster_levels <- colnames(split_corMat)[clusters$order] # Fetch rearranged cell type labels
cluster_levels <- c("CM-19-2", "CM-19-1", "FB-17", "EN-18")

# Pivot split_corMat to long data format
cors <- tidyr::pivot_longer(split_corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(split_corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_subset_2_age_2.pdf"), width = 5, height = 4)
p
dev.off()
```


### SUBSETS_3: "FB-4", "EN-7", "EN-17"

```{r}
split_corMat <- corMat[c("FB-4", "EN-7", "EN-17"), 
                       c("FB-4", "EN-7", "EN-17")]
pheatmap(split_corMat, border_color = NA, color = heatmap_colors)
```


#### Better control of the Heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(split_corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
#cluster_levels <- colnames(split_corMat)[clusters$order] # Fetch rearranged cell type labels
cluster_levels <- c("FB-4", "EN-7", "EN-17")

# Pivot split_corMat to long data format
cors <- tidyr::pivot_longer(split_corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(split_corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_subset_3_age_2.pdf"), width = 5, height = 4)
p
dev.off()
```


### ST_age3 - Pairwise correlation

#### Correlation matrix between ST and stereoscope assay

```{r}
corMat <- cor(GetAssayData(ST_age3, assay = "stereoscope_dl", slot = "data") |> t())
dim(corMat)
```


#### Set diagonal to NA

```{r}
diag(corMat) <- NA
```


#### Visualization

```{r}
heatmap_colors <- colorRampPalette(RColorBrewer::brewer.pal(n = 11, name = "RdBu") |> rev())(50)

pheatmap(corMat, border_color = NA, color = heatmap_colors)
```


#### Better control of the Heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- colnames(corMat)[clusters$order] # Fetch rearranged cell type labels

# Pivot corMat to long data format
cors <- tidyr::pivot_longer(corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_age3.pdf"), width = 30, height = 30)
p
dev.off()
```


### SUBSETS_1: "CM-4-1", "CM-4-2", "EN-1", "EN-12", "CM-18"

```{r}
split_corMat <- corMat[c("CM-4-1", "CM-4-2", "EN-1", "EN-12", "CM-18"), 
                       c("CM-4-1", "CM-4-2", "EN-1", "EN-12", "CM-18")]
pheatmap(split_corMat, border_color = NA, color = heatmap_colors)
```


#### Better control of the Heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(split_corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
#cluster_levels <- colnames(split_corMat)[clusters$order] # Fetch rearranged cell type labels
cluster_levels <- c("CM-4-1", "CM-4-2", "EN-1", "EN-12", "CM-18")

# Pivot split_corMat to long data format
cors <- tidyr::pivot_longer(split_corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(split_corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_subset_1_age_3.pdf"), width = 5, height = 4)
p
dev.off()
```


### SUBSETS_2: "CM-19-2", "CM-19-1", "FB-17", "EN-18"

```{r}
split_corMat <- corMat[c("CM-19-2", "CM-19-1", "FB-17", "EN-18"), 
                       c("CM-19-2", "CM-19-1", "FB-17", "EN-18")]
pheatmap(split_corMat, border_color = NA, color = heatmap_colors)
```


#### Better control of the Heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(split_corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
#cluster_levels <- colnames(split_corMat)[clusters$order] # Fetch rearranged cell type labels
cluster_levels <- c("CM-19-2", "CM-19-1", "FB-17", "EN-18")

# Pivot split_corMat to long data format
cors <- tidyr::pivot_longer(split_corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(split_corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_subset_2_age_3.pdf"), width = 5, height = 4)
p
dev.off()
```


### SUBSETS_3: "FB-4", "EN-7", "EN-17"

```{r}
split_corMat <- corMat[c("FB-4", "EN-7", "EN-17"), 
                       c("FB-4", "EN-7", "EN-17")]
pheatmap(split_corMat, border_color = NA, color = heatmap_colors)
```


#### Better control of the Heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(split_corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
#cluster_levels <- colnames(split_corMat)[clusters$order] # Fetch rearranged cell type labels
cluster_levels <- c("FB-4", "EN-7", "EN-17")

# Pivot split_corMat to long data format
cors <- tidyr::pivot_longer(split_corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(split_corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_subset_3_age_3.pdf"), width = 5, height = 4)
p
dev.off()
```



================================================================================
================================================================================

## Network correlation graph

From the correlation about cell types co-localization, plot a network graph instead of the heatmaps for simplify visualization.

### High Level

```{r}
set.seed(1)
corMat_network <- cor(GetAssayData(ST, assay = "stereoscope", slot = "data") |> t())
corMat_network[corMat_network<0.04] <- 0
network <- graph_from_adjacency_matrix(corMat_network, weighted=T, mode="undirected", diag=F)

# Count the number of degree for each node:
deg <- degree(network, mode="all")
 
# Plot
plot(network, vertex.size=deg*2, vertex.color=rgb(0.1,0.7,0.8,0.5))
```


### Deep Level

```{r}
DefaultAssay(ST_age1) <- "stereoscope_dl"
DefaultAssay(ST_age2) <- "stereoscope_dl"
DefaultAssay(ST_age3) <- "stereoscope_dl"
```


#### Cell types to exclude from the network graph

```{r}
cell_types_to_exclude <- c("CM-5", "CM-17", "EN-5", "FB-2", "FB-12", "IN-11", "IN-12", "IN-17", "IN-3", "IN-4", "IN-7")
```


#### ST deep level all ages

```{r}
set.seed(1)

DefaultAssay(ST) <- "stereoscope_dl"

# Subset ST object for cell types of interest
ST_nw <- ST[!(rownames(ST) %in% cell_types_to_exclude), ]

# Calculate Pearson's correlation scores for remaining cell types
corMat_network <- cor(GetAssayData(ST_nw, assay = "stereoscope_dl", slot = "data") |> t())

# Keep Pearson's scores above threshold (can't work with negative scores)
corMat_network[corMat_network<0.070] <- 0

# Generate network graph based on the remaining correlation score
network <- graph_from_adjacency_matrix(corMat_network, weighted=T, mode="undirected", diag=F)

# Count the number of degree for each node:
deg <- degree(network, mode="all")
 
# Plot
pdf(file = paste0(myfolder, "networks/deeplevel_all_0070.pdf"), width = 10, height = 10)
plot(network, vertex.size=deg*1.1, vertex.color=rgb(0.1,0.7,0.8,0.5))
dev.off()
```


#### ST_age1

```{r}
set.seed(1)

# Subset ST object for cell types of interest
ST_age1_nw <- ST_age1[!(rownames(ST_age1) %in% cell_types_to_exclude), ]

# Calculate Pearson's correlation scores for remaining cell types
corMat_network <- cor(GetAssayData(ST_age1_nw, assay = "stereoscope_dl", slot = "data") |> t())

# Keep Pearson's scores above threshold (can't work with negative scores)
corMat_network[corMat_network<0.070] <- 0

# Generate network graph based on the remaining correlation score
network <- graph_from_adjacency_matrix(corMat_network, weighted=T, mode="undirected", diag=F)

# Count the number of degree for each node:
deg <- degree(network, mode="all")
 
# Plot
pdf(file = paste0(myfolder, "networks/deeplevel_age1_0070.pdf"), width = 10, height = 10)
plot(network, vertex.size=deg*1.1, vertex.color=rgb(0.1,0.7,0.8,0.5))
dev.off()
```


#### ST_age2

```{r}
set.seed(1)

# Subset ST object for cell types of interest
ST_age2_nw <- ST_age2[!(rownames(ST_age2) %in% cell_types_to_exclude), ]

# Calculate Pearson's correlation scores for remaining cell types
corMat_network <- cor(GetAssayData(ST_age2_nw, assay = "stereoscope_dl", slot = "data") |> t())

# Keep Pearson's scores above threshold (can't work with negative scores)
corMat_network[corMat_network<0.070] <- 0

# Generate network graph based on the remaining correlation score
network <- graph_from_adjacency_matrix(corMat_network, weighted=T, mode="undirected", diag=F)

# Count the number of degree for each node:
deg <- degree(network, mode="all")
 
# Plot
pdf(file = paste0(myfolder, "networks/deeplevel_age2_0070.pdf"), width = 10, height = 10)
plot(network, vertex.size=deg*1.1, vertex.color=rgb(0.1,0.7,0.8,0.5))
dev.off()
```


#### ST_age3

```{r}
set.seed(1)

# Subset ST object for cell types of interest
ST_age3_nw <- ST_age3[!(rownames(ST_age3) %in% cell_types_to_exclude), ]

# Calculate Pearson's correlation scores for remaining cell types
corMat_network <- cor(GetAssayData(ST_age3_nw, assay = "stereoscope_dl", slot = "data") |> t())

# Keep Pearson's scores above threshold (can't work with negative scores)
corMat_network[corMat_network<0.070] <- 0

# Generate network graph based on the remaining correlation score
network <- graph_from_adjacency_matrix(corMat_network, weighted=T, mode="undirected", diag=F)

# Count the number of degree for each node:
deg <- degree(network, mode="all")
 
# Plot
pdf(file = paste0(myfolder, "networks/deeplevel_age3_0070.pdf"), width = 10, height = 10)
plot(network, vertex.size=deg*1.1, vertex.color=rgb(0.1,0.7,0.8,0.5))
dev.off()
```


================================================================================
================================================================================

## CO-LOCALIZATION

### Set default assay to `stereoscope_dl´

```{r}
DefaultAssay(ST) <- "stereoscope_dl"
ST
```


#### "CM-19-1", "CM-19-2"

```{r}
plots <- CellColoc(ST,
                      features = c("CM-19-1", "CM-19-2"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/SAN_AVN_section_16.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


#### "CM-4-2", "CM-4-1" - 4 different sections

```{r}
# time point 1
plots1 <- CellColoc(ST,
                      features = c("CM-4-2", "CM-4-1"),
                      section_number = 5)

# time point 2
plots2 <- CellColoc(ST, 
                      features = c("CM-4-2", "CM-4-1"),
                      section_number = 2)

# time point 3
plots3 <- CellColoc(ST, 
                      features = c("CM-4-2", "CM-4-1"),
                      section_number = 11)

# time point 4
plots4 <- CellColoc(ST, 
                      features = c("CM-4-2", "CM-4-1"),
                      section_number = 24)

p <- plots1[[3]] + plots2[[3]] + plots3[[3]] + plots4[[3]]  +
    patchwork::plot_layout(ncol = 4)

pdf(file = paste0(myfolder, "colocalization/purkinje_pre_purkinje.pdf"), width = 15.75, height = 4.5)
p
dev.off()
```


##### section5

```{r}
plots <- CellColoc(ST,
                      features = c("CM-4-2", "CM-4-1"),
                      section_number = 5)

pdf(file = paste0(myfolder, "colocalization/purkinje_pre_purkinje_section5.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


##### section2

```{r}
plots <- CellColoc(ST,
                      features = c("CM-4-2", "CM-4-1"),
                      section_number = 2)

pdf(file = paste0(myfolder, "colocalization/purkinje_pre_purkinje_section2.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


##### section11

```{r}
plots <- CellColoc(ST,
                      features = c("CM-4-2", "CM-4-1"),
                      section_number = 11)

pdf(file = paste0(myfolder, "colocalization/purkinje_pre_purkinje_section11.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


##### section24

```{r}
plots <- CellColoc(ST,
                      features = c("CM-4-2", "CM-4-1"),
                      section_number = 24)

pdf(file = paste0(myfolder, "colocalization/purkinje_pre_purkinje_section24.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


#### "CM-19-1", "CM-18", "CM-8-2"

```{r}
plots <- CellColoc3(ST,
                      features = c("CM-19-1", "CM-18", "CM-8-2"),
                      section_number = 3)

pdf(file = paste0(myfolder, "colocalization/AVN_cond_compact_myo_His_Tawara_section_3.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("CM-19-1", "CM-18", "CM-8-2"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/AVN_cond_compact_myo_His_Tawara_section_16.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "CM-4-2", "CM-18", "CM-8-2"

```{r}
plots <- CellColoc3(ST,
                      features = c("CM-4-2", "CM-18", "CM-8-2"),
                      section_number = 3)

pdf(file = paste0(myfolder, "colocalization/Purkinje_cond_compact_myo_His_Tawara_section_3.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("CM-4-2", "CM-18", "CM-8-2"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/Purkinje_cond_compact_myo_His_Tawara_section_16.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "CM-4-2", "CM-18"

```{r}
plots <- CellColoc(ST,
                      features = c("CM-4-2", "CM-18"),
                      section_number = 3)

pdf(file = paste0(myfolder, "colocalization/Ventricular_conduction_system_section_3.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```

```{r}
plots <- CellColoc(ST,
                      features = c("CM-4-2", "CM-18"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/Ventricular_conduction_system_section_16.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


#### "FB-11", "CM-8-2"

```{r}
plots <- CellColoc(ST,
                      features = c("FB-11", "CM-8-2"),
                      section_number = 28,
                      colors = c("red", "blue"))

pdf(file = paste0(myfolder, "colocalization/Coloc_FM-CM_section_28.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


#### "FB-4", "FB-11", "FB-13"

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-4", "FB-11", "FB-13"),
                      section_number = 2)

pdf(file = paste0(myfolder, "colocalization/Valve-related_FB _section_2.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-4", "FB-11", "FB-13"),
                      section_number = 28)

pdf(file = paste0(myfolder, "colocalization/Valve-related_FB _section_28.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-4", "FB-11", "FB-13"),
                      section_number = 20)

pdf(file = paste0(myfolder, "colocalization/Valve-related_FB _section_20.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-4", "FB-11", "FB-13"),
                      section_number = 21)

pdf(file = paste0(myfolder, "colocalization/Valve-related_FB _section_21.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-4", "FB-11", "FB-13"),
                      section_number = 29)

pdf(file = paste0(myfolder, "colocalization/Valve-related_FB _section_29.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-4", "FB-11", "FB-13"),
                      section_number = 2,
                      max_feature1 = 0.30,
                      max_feature2 = 0.23,
                      max_feature3 = 0.22)

pdf(file = paste0(myfolder, "colocalization/Valve-related_FB _section_2_rescaled.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-4", "FB-11", "FB-13"),
                      section_number = 27,
                      max_feature1 = 0.30,
                      max_feature2 = 0.23,
                      max_feature3 = 0.22)

pdf(file = paste0(myfolder, "colocalization/Valve-related_FB _section_27_rescaled.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "FB-5", "FB-9", FB-19" - 4 different sections

```{r}
# time point 1
plots1 <- CellColoc3(ST,
                      features = c("FB-5", "FB-9", "FB-19"),
                      section_number = 5)

# time point 2
plots2 <- CellColoc3(ST,
                      features = c("FB-5", "FB-9", "FB-19"),
                      section_number = 2)

# time point 3
plots3 <- CellColoc3(ST,
                      features = c("FB-5", "FB-9", "FB-19"),
                      section_number = 11)

# time point 4
plots4 <- CellColoc3(ST,
                      features = c("FB-5", "FB-9", "FB-19"),
                      section_number = 24)

p <- plots1[[4]] + plots2[[4]] + plots3[[4]] + plots4[[4]]  +
    patchwork::plot_layout(ncol = 4)

pdf(file = paste0(myfolder, "colocalization/interstitial_FB.pdf"), width = 15.75, height = 4.5)
p
dev.off()
```


##### section5

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-5", "FB-9", "FB-19"),
                      section_number = 5)

pdf(file = paste0(myfolder, "colocalization/interstitial_FB_section_5.pdf"), width = 20, height = 6)
plots
dev.off()
```


##### section2

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-5", "FB-9", "FB-19"),
                      section_number = 2)

pdf(file = paste0(myfolder, "colocalization/interstitial_FB_section_2.pdf"), width = 20, height = 6)
plots
dev.off()
```


##### section11

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-5", "FB-9", "FB-19"),
                      section_number = 11)

pdf(file = paste0(myfolder, "colocalization/interstitial_FB_section_11.pdf"), width = 20, height = 6)
plots
dev.off()
```


##### section24

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-5", "FB-9", "FB-19"),
                      section_number = 24)

pdf(file = paste0(myfolder, "colocalization/interstitial_FB_section_24.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "FB-7", "FB-3", "FB-18" - 4 different sections

```{r}
# time point 1
plots1 <- CellColoc3(ST,
                      features = c("FB-7", "FB-3", "FB-18"),
                      section_number = 5)

# time point 2
plots2 <- CellColoc3(ST,
                      features = c("FB-7", "FB-3", "FB-18"),
                      section_number = 2)

# time point 3
plots3 <- CellColoc3(ST,
                      features = c("FB-7", "FB-3", "FB-18"),
                      section_number = 11)

# time point 4
plots4 <- CellColoc3(ST,
                      features = c("FB-7", "FB-3", "FB-18"),
                      section_number = 24)

p <- plots1[[4]] + plots2[[4]] + plots3[[4]] + plots4[[4]]  +
    patchwork::plot_layout(ncol = 4)

pdf(file = paste0(myfolder, "colocalization/Epi_derived_FB_1.pdf"), width = 15.75, height = 4.5)
p
dev.off()
```


##### section5

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-7", "FB-3", "FB-18"),
                      section_number = 5)

pdf(file = paste0(myfolder, "colocalization/Epi_derived_FB_1_section_5.pdf"), width = 20, height = 6)
plots
dev.off()
```


##### section2

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-7", "FB-3", "FB-18"),
                      section_number = 2)

pdf(file = paste0(myfolder, "colocalization/Epi_derived_FB_1_section_2.pdf"), width = 20, height = 6)
plots
dev.off()
```


##### section11

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-7", "FB-3", "FB-18"),
                      section_number = 11)

pdf(file = paste0(myfolder, "colocalization/Epi_derived_FB_1_section_11.pdf"), width = 20, height = 6)
plots
dev.off()
```


##### section24

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-7", "FB-3", "FB-18"),
                      section_number = 24)

pdf(file = paste0(myfolder, "colocalization/Epi_derived_FB_1_section_24.pdf"), width = 20, height = 6)
plots
dev.off()
```



#### "FB-7", "FB-3", "FB-8"

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-7", "FB-3", "FB-8"),
                      section_number = 3)

pdf(file = paste0(myfolder, "colocalization/Epi_derived_FB_2_section_3.pdf"), width = 20, height = 6)
plots
dev.off()
```


```{r}
plots <- CellColoc3(ST,
                      features = c("FB-7", "FB-3", "FB-8"),
                      section_number = 11)

pdf(file = paste0(myfolder, "colocalization/Epi_derived_FB_2_section_11.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "CM19-1", "FB-17", "EC-18"

```{r}
plots <- CellColoc3(ST,
                      features = c("CM-19-1", "FB-17", "EN-18"),
                      section_number = 19)

pdf(file = paste0(myfolder, "colocalization/Coloc_atrial_septum_section_19.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "EN-18", "EN-6"

```{r}
plots <- CellColoc(ST,
                      features = c("EN-18", "EN-6"),
                      section_number = 18)

pdf(file = paste0(myfolder, "colocalization/Atrial_septum_related_EN_section_18.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


#### "EN-7", "EN-17"

```{r}
plots <- CellColoc(ST,
                      features = c("EN-7", "EN-17"),
                      section_number = 2)

pdf(file = paste0(myfolder, "colocalization/Valve_related_EN_section_2.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


```{r}
plots <- CellColoc(ST,
                      features = c("EN-7", "EN-17"),
                      section_number = 20)

pdf(file = paste0(myfolder, "colocalization/Valve_related_EN_section_20.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


```{r}
plots <- CellColoc(ST,
                      features = c("EN-7", "EN-17"),
                      section_number = 6)

pdf(file = paste0(myfolder, "colocalization/Valve_related_EN_section_6.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


#### "EN-6", "EN-18", "EN-16"

```{r}
plots <- CellColoc3(ST,
                      features = c("EN-6", "EN-18", "EN-16"),
                      section_number = 18)

pdf(file = paste0(myfolder, "colocalization/EN-6_EN-18_EN-16_section_18.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "EN-1", "EN-12" - 4 different sections

```{r}
# time point 1
plots1 <- CellColoc(ST,
                      features = c("EN-1", "EN-12"),
                      section_number = 5)

# time point 2
plots2 <- CellColoc(ST,
                      features = c("EN-1", "EN-12"),
                      section_number = 2)

# time point 3
plots3 <- CellColoc(ST,
                      features = c("EN-1", "EN-12"),
                      section_number = 11)

# time point 4
plots4 <- CellColoc(ST,
                      features = c("EN-1", "EN-12"),
                      section_number = 24)

p <- plots1[[3]] + plots2[[3]] + plots3[[3]] + plots4[[3]]  +
    patchwork::plot_layout(ncol = 4)

pdf(file = paste0(myfolder, "colocalization/Endocardium_1.pdf"), width = 15.75, height = 4.5)
p
dev.off()
```


##### section5

```{r}
plots <- CellColoc(ST,
                      features = c("EN-1", "EN-12"),
                      section_number = 5)

pdf(file = paste0(myfolder, "colocalization/Endocardium_1_section_5.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


##### section2

```{r}
plots <- CellColoc(ST,
                      features = c("EN-1", "EN-12"),
                      section_number = 2)

pdf(file = paste0(myfolder, "colocalization/Endocardium_1_section_2.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


##### section11

```{r}
plots <- CellColoc(ST,
                      features = c("EN-1", "EN-12"),
                      section_number = 11)

pdf(file = paste0(myfolder, "colocalization/Endocardium_1_section_11.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


##### section24

```{r}
plots <- CellColoc(ST,
                      features = c("EN-1", "EN-12"),
                      section_number = 24)

pdf(file = paste0(myfolder, "colocalization/Endocardium_1_section_24.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


#### "EN-3", "EN-6" - 4 different sections

```{r}
# time point 1
plots1 <- CellColoc(ST,
                      features = c("EN-3", "EN-6"),
                      section_number = 5)

# time point 2
plots2 <- CellColoc(ST,
                      features = c("EN-3", "EN-6"),
                      section_number = 2)

# time point 3
plots3 <- CellColoc(ST,
                      features = c("EN-3", "EN-6"),
                      section_number = 11)

# time point 4
plots4 <- CellColoc(ST,
                      features = c("EN-3", "EN-6"),
                      section_number = 24)

p <- plots1[[3]] + plots2[[3]] + plots3[[3]] + plots4[[3]]  +
    patchwork::plot_layout(ncol = 4)

pdf(file = paste0(myfolder, "colocalization/Endocardium_2.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


##### section5

```{r}
plots <- CellColoc(ST,
                      features = c("EN-3", "EN-6"),
                      section_number = 5)

pdf(file = paste0(myfolder, "colocalization/Endocardium_2_section_5.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


##### section2

```{r}
plots <- CellColoc(ST,
                      features = c("EN-3", "EN-6"),
                      section_number = 2)

pdf(file = paste0(myfolder, "colocalization/Endocardium_2_section_2.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


##### section11

```{r}
plots <- CellColoc(ST,
                      features = c("EN-3", "EN-6"),
                      section_number = 11)

pdf(file = paste0(myfolder, "colocalization/Endocardium_2_section_11.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


##### section24

```{r}
plots <- CellColoc(ST,
                      features = c("EN-3", "EN-6"),
                      section_number = 24)

pdf(file = paste0(myfolder, "colocalization/Endocardium_2_section_24.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


##### section27

```{r}
plots <- CellColoc(ST,
                      features = c("EN-3", "EN-6"),
                      section_number = 27)

pdf(file = paste0(myfolder, "colocalization/Endocardium_2_section_27.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```



#### "EN-2", "EN-10" - 4 different sections

```{r}
# time point 1
plots1 <- CellColoc(ST,
                      features = c("EN-2", "EN-10"),
                      section_number = 5)

# time point 2
plots2 <- CellColoc(ST,
                      features = c("EN-2", "EN-10"),
                      section_number = 2)

# time point 3
plots3 <- CellColoc(ST,
                      features = c("EN-2", "EN-10"),
                      section_number = 11)

# time point 4
plots4 <- CellColoc(ST,
                      features = c("EN-2", "EN-10"),
                      section_number = 24)

p <- plots1[[3]] + plots2[[3]] + plots3[[3]] + plots4[[3]]  +
    patchwork::plot_layout(ncol = 4)

pdf(file = paste0(myfolder, "colocalization/Capillary.pdf"), width = 15.75, height = 4.5)
p
dev.off()
```


##### section5

```{r}
plots <- CellColoc(ST,
                      features = c("EN-2", "EN-10"),
                      section_number = 5)

pdf(file = paste0(myfolder, "colocalization/Capillary_section_5.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


##### section2

```{r}
plots <- CellColoc(ST,
                      features = c("EN-2", "EN-10"),
                      section_number = 2)

pdf(file = paste0(myfolder, "colocalization/Capillary_section_2.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


##### section11

```{r}
plots <- CellColoc(ST,
                      features = c("EN-2", "EN-10"),
                      section_number = 11)

pdf(file = paste0(myfolder, "colocalization/Capillary_section_11.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


##### section24

```{r}
plots <- CellColoc(ST,
                      features = c("EN-2", "EN-10"),
                      section_number = 24)

pdf(file = paste0(myfolder, "colocalization/Capillary_section_24.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


#### "CM-8-2", "FB-11", "FB-19"

```{r}
plots <- CellColoc3(ST,
                      features = c("CM-8-2", "FB-11", "FB-19"),
                      section_number = 4)

pdf(file = paste0(myfolder, "colocalization/CM-8-2_FB-11_FB-19_section_4.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "CM-9", "CM-14", "EN-18"

```{r}
plots <- CellColoc3(ST,
                      features = c("CM-9", "CM-14", "EN-18"),
                      section_number = 27)

pdf(file = paste0(myfolder, "colocalization/CM-9_CM-14_EN-18_section_27.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "IN"

```{r}
pairs <- list(c("IN-1", "IN-13"),
              c("IN-1", "HL-29"),
              c("IN-1", "IN-8"),
              c("IN-1", "IN-19"),
              
              c("IN-13", "HL-29"),
              c("IN-13", "IN-8"),
              c("IN-13", "IN-19"),
              
              c("HL-29", "IN-8"),
              c("HL-29", "IN-19"),
              
              c("IN-8", "IN-19"))

for (pair in pairs) {
  print(pair)
}
```


```{r}
for (pair in pairs) {
  plots <- CellColoc(ST,
                      features = pair,
                      section_number = 16)

  pdf(file = paste0(myfolder, "colocalization/IN_section_16_", pair[1], "_", pair[2], ".pdf"), width = 15.75, height = 4.5)
  print(plots)
  dev.off()
}
```


#### "IN-1", "IN-3", "IN-13"

```{r}
plots <- CellColoc3(ST,
                      features = c("IN-3", "IN-13", "IN-1"),
                      section_number = 15)

pdf(file = paste0(myfolder, "colocalization/IN-3_IN-13_IN-1_section_15.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("IN-3", "IN-13", "IN-1"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/IN-3_IN-13_IN-1_section_16.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("IN-3", "IN-13", "IN-1"),
                      section_number = 22)

pdf(file = paste0(myfolder, "colocalization/IN-3_IN-13_IN-1_section_22.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "IN-8", "IN-19"

```{r}
plots <- CellColoc(ST,
                      features = c("IN-8", "IN-19"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/IN-8_IN-19_section_16.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


#### "IN-1", "CM-19-1", "CM-19-2"

```{r}
plots <- CellColoc3(ST,
                      features = c("CM-19-1", "CM-19-2", "IN-1"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/CM-19-1_CM-19-2_IN-1_section_16.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("CM-19-1", "CM-19-2", "IN-1"),
                      section_number = 26)

pdf(file = paste0(myfolder, "colocalization/CM-19-1_CM-19-2_IN-1_section_26.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### IN-1, IN-13, CM-19-2 

```{r}
plots <- CellColoc3(ST,
                      features = c("IN-13", "CM-19-2", "IN-1"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/IN-13_CM-19-2_IN-1_section_16.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "IN-13", "CM-19-2"

```{r}
plots <- CellColoc(ST,
                      features = c("IN-13", "CM-19-2"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/IN-13_CM-19-2_section_16.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```

```{r}
plots <- CellColoc(ST,
                      features = c("IN-13", "CM-19-2"),
                      section_number = 18)

pdf(file = paste0(myfolder, "colocalization/IN-13_CM-19-2_section_18.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```

```{r}
plots <- CellColoc(ST,
                      features = c("IN-13", "CM-19-2"),
                      section_number = 19)

pdf(file = paste0(myfolder, "colocalization/IN-13_CM-19-2_section_19.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```

```{r}
plots <- CellColoc(ST,
                      features = c("IN-13", "CM-19-2"),
                      section_number = 21)

pdf(file = paste0(myfolder, "colocalization/IN-13_CM-19-2_section_21.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


#### IN-1, IN-13, IN-19 

```{r}
plots <- CellColoc3(ST,
                      features = c("IN-13", "IN-19", "IN-1"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/IN-13_IN-19_IN-1_section_16.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "IN-13", "CM-19-1"

```{r}
plots <- CellColoc(ST,
                      features = c("IN-13", "CM-19-1"),
                      section_number = 24)

pdf(file = paste0(myfolder, "colocalization/IN-13_CM-19-1_section_24.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```

```{r}
plots <- CellColoc(ST,
                      features = c("IN-13", "CM-19-1"),
                      section_number = 28)

pdf(file = paste0(myfolder, "colocalization/IN-13_CM-19-1_section_28.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


####  "IN-13", "CM-14", "IN-1"  in sc. 22

```{r}
plots <- CellColoc3(ST,
                      features = c("IN-13", "CM-14", "IN-1"),
                      section_number = 22)

pdf(file = paste0(myfolder, "colocalization/IN-13_CM-14_IN-1_section_22.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "IN-13",  "FB-1",  "IN-1"   in sc. 32 and 34

```{r}
plots <- CellColoc3(ST,
                      features = c("IN-13",  "FB-1",  "IN-1"),
                      section_number = 32)

pdf(file = paste0(myfolder, "colocalization/IN-13_FB-1_IN-1_section_32.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("IN-13",  "FB-1",  "IN-1"),
                      section_number = 34)

pdf(file = paste0(myfolder, "colocalization/IN-13_FB-1_IN-1_section_34.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "CM-8-2", "CM-18", "CM-19-1"   in sc. 3

```{r}
plots <- CellColoc3(ST,
                      features = c("CM-8-2", "CM-18", "CM-19-1"),
                      section_number = 3)

pdf(file = paste0(myfolder, "colocalization/CM-8-2_CM-18_CM-19-1_section_3.pdf"), width = 20, height = 6)
plots
dev.off()
```


####  "CM-9", "CM-14" in sc. 3

```{r}
plots <- CellColoc(ST,
                      features = c("CM-9", "CM-14"),
                      section_number = 3)

pdf(file = paste0(myfolder, "colocalization/CM-9_CM-14_section_3.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


####  "CM-6", "CM-1", "CM-10" in sc. 3

```{r}
plots <- CellColoc3(ST,
                      features = c("CM-6", "CM-1", "CM-10"),
                      section_number = 3)

pdf(file = paste0(myfolder, "colocalization/CM-6_CM-1_CM-10_section_3.pdf"), width = 20, height = 6)
plots
dev.off()
```


####  "CM-19-2", "CM-19-1" sc. 19 and 28

```{r}
plots <- CellColoc(ST,
                      features = c("CM-19-2", "CM-19-1"),
                      section_number = 19)

pdf(file = paste0(myfolder, "colocalization/CM-19-2_CM-19-1_section_19.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```

```{r}
plots <- CellColoc(ST,
                      features = c("CM-19-2", "CM-19-1"),
                      section_number = 28)

pdf(file = paste0(myfolder, "colocalization/CM-19-2_CM-19-1_section_28.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


### group needed plot

#### "FB-1", "FB-6" sc. 9, 16

```{r}
plots <- CellColoc(ST,
                      features = c("FB-1", "FB-6"),
                      section_number = 9)

pdf(file = paste0(myfolder, "colocalization/FB-1_FB-6_section_9.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```

```{r}
plots <- CellColoc(ST,
                      features = c("FB-1", "FB-6"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/FB-1_FB-6_section_16.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


#### "FB-1", "HL-8", "EN-19", sc.9, 12, 20

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-1", "HL-8", "EN-19"),
                      section_number = 9)

pdf(file = paste0(myfolder, "colocalization/FB-1_HL-8_EN-19_section_9.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-1", "HL-8", "EN-19"),
                      section_number = 12)

pdf(file = paste0(myfolder, "colocalization/FB-1_HL-8_EN-19_section_12.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-1", "HL-8", "EN-19"),
                      section_number = 20)

pdf(file = paste0(myfolder, "colocalization/FB-1_HL-8_EN-19_section_20.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "FB-6", "HL-10", "EN-15", sc. 9, 16, 24

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-6", "HL-10", "EN-15"),
                      section_number = 9)

pdf(file = paste0(myfolder, "colocalization/FB-6_HL-10_EN-15_section_9.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-6", "HL-10", "EN-15"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/FB-6_HL-10_EN-15_section_16.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-6", "HL-10", "EN-15"),
                      section_number = 24)

pdf(file = paste0(myfolder, "colocalization/FB-6_HL-10_EN-15_section_24.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "FB-15", "HL-22", sc. 9, 10, 33

```{r}
plots <- CellColoc(ST,
                      features = c("FB-15", "HL-22"),
                      section_number = 9)

pdf(file = paste0(myfolder, "colocalization/FB-15_HL-22_section_9.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```

```{r}
plots <- CellColoc(ST,
                      features = c("FB-15", "HL-22"),
                      section_number = 10)

pdf(file = paste0(myfolder, "colocalization/FB-15_HL-22_section_10.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```

```{r}
plots <- CellColoc(ST,
                      features = c("FB-15", "HL-22"),
                      section_number = 33)

pdf(file = paste0(myfolder, "colocalization/FB-15_HL-22_section_33.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


#### "HL-20", "FB-7", "FB-8" sc.11

```{r}
plots <- CellColoc3(ST,
                      features = c("HL-20", "FB-7", "FB-8"),
                      section_number = 11)

pdf(file = paste0(myfolder, "colocalization/HL-20_FB-7_FB-8_section_11.pdf"), width = 20, height = 6)
plots
dev.off()
```

#### "HL-20", "FB-7", "FB-3" sc.11

```{r}
plots <- CellColoc3(ST,
                      features = c("HL-20", "FB-7", "FB-3"),
                      section_number = 11)

pdf(file = paste0(myfolder, "colocalization/HL-20_FB-7_FB-3_section_11.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "FB-4", "FB-11", "FB-13", sc. 2, 20, 22, 33

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-4", "FB-11", "FB-13"),
                      section_number = 2)

pdf(file = paste0(myfolder, "colocalization/FB-4_FB-11_FB-13_section_2.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-4", "FB-11", "FB-13"),
                      section_number = 20)

pdf(file = paste0(myfolder, "colocalization/FB-4_FB-11_FB-13_section_20.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-4", "FB-11", "FB-13"),
                      section_number = 22)

pdf(file = paste0(myfolder, "colocalization/FB-4_FB-11_FB-13_section_22.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-4", "FB-11", "FB-13"),
                      section_number = 33)

pdf(file = paste0(myfolder, "colocalization/FB-4_FB-11_FB-13_section_33.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "EN-20", "HL-15", "FB-7", sc. 11, 16, 23

```{r}
plots <- CellColoc3(ST,
                      features = c("EN-20", "HL-15", "FB-7"),
                      section_number = 11)

pdf(file = paste0(myfolder, "colocalization/EN-20_HL-15_FB-7_section_11.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("EN-20", "HL-15", "FB-7"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/EN-20_HL-15_FB-7_section_16.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("EN-20", "HL-15", "FB-7"),
                      section_number = 23)

pdf(file = paste0(myfolder, "colocalization/EN-20_HL-15_FB-7_section_23.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "FB-7", "FB-8", "FB-14", sc. 23

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-7", "FB-8", "FB-14"),
                      section_number = 23)

pdf(file = paste0(myfolder, "colocalization/FB-7_FB-8_FB-14_section_23.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "EN-7", "EN-17", "FB-4", sc. 2, 20

```{r}
plots <- CellColoc3(ST,
                      features = c("EN-7", "EN-17", "FB-4"),
                      section_number = 2)

pdf(file = paste0(myfolder, "colocalization/EN-7_EN-17_FB-4_section_2.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("EN-7", "EN-17", "FB-4"),
                      section_number = 20)

pdf(file = paste0(myfolder, "colocalization/EN-7_EN-17_FB-4_section_20.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "CM-19-2", "CM-19-1", "FB-17", sc. 19, 25

```{r}
plots <- CellColoc3(ST,
                      features = c("CM-19-2", "CM-19-1", "FB-17"),
                      section_number = 19)

pdf(file = paste0(myfolder, "colocalization/CM-19-2_CM-19-1_FB-17_section_19.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("CM-19-2", "CM-19-1", "FB-17"),
                      section_number = 25)

pdf(file = paste0(myfolder, "colocalization/CM-19-2_CM-19-1_FB-17_section_25.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "FB-5", "FB-9", "FB-19", sc. 5, 2, 11, 24

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-5", "FB-9", "FB-19"),
                      section_number = 5)

pdf(file = paste0(myfolder, "colocalization/FB-5_FB-9_FB-19_section_5.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-5", "FB-9", "FB-19"),
                      section_number = 2)

pdf(file = paste0(myfolder, "colocalization/FB-5_FB-9_FB-19_section_2.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-5", "FB-9", "FB-19"),
                      section_number = 11)

pdf(file = paste0(myfolder, "colocalization/FB-5_FB-9_FB-19_section_11.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-5", "FB-9", "FB-19"),
                      section_number = 24)

pdf(file = paste0(myfolder, "colocalization/FB-5_FB-9_FB-19_section_24.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "FB-3", "FB-7", "FB-8", sc. 9

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-3", "FB-7", "FB-8"),
                      section_number = 9)

pdf(file = paste0(myfolder, "colocalization/FB-3_FB-7_FB-8_section_9.pdf"), width = 20, height = 6)
plots
dev.off()
```

### For ST-seminar

#### "EN-20", "HL-15"

```{r}
# time point 1
plots1 <- CellColoc(ST,
                      features = c("EN-20", "HL-15"),
                      section_number = 5)

# time point 2
plots2 <- CellColoc(ST,
                      features = c("EN-20", "HL-15"),
                      section_number = 2)

# time point 3
plots3 <- CellColoc(ST,
                      features = c("EN-20", "HL-15"),
                      section_number = 11)

# time point 4
plots4 <- CellColoc(ST,
                      features = c("EN-20", "HL-15"),
                      section_number = 24)

p <- plots1[[3]] + plots2[[3]] + plots3[[3]] + plots4[[3]]  +
    patchwork::plot_layout(ncol = 4)

pdf(file = paste0(myfolder, "colocalization/EN-20_HL-15.pdf"), width = 15.75, height = 4.5)
p
dev.off()
```


```{r}
plots <- CellColoc(ST,
                      features = c("EN-20", "HL-15"),
                      section_number = 28)

pdf(file = paste0(myfolder, "colocalization/EN-20_HL-15_section_28.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```

================================================================================
================================================================================
================================================================================
================================================================================
================================================================================










