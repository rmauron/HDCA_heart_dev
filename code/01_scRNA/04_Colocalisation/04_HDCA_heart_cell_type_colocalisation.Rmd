---
title: "04_HDCA_heart_cell_type_colocalisation"
author: "Raphaël Mauron"
output: html_document
editor_options: 
  chunk_output_type: console
---

# HDCA heart cell type colocalisation

A specific environment as been created to run this script. The reason being we are using the package called ´semla´ (https://github.com/ludvigla/semla) which has dependencies and was not installed at the beginning of the overall analysis.
To avoid any dependencies issues, it has been decided to run this code separately.

NOTE: The path to load the data and the path to save the figures should be changed at your convenience.

Environment: **Conda: r-semla**

## Set up and loading material

### Knit setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### Load library

```{r}
library(semla)
library(dplyr)
library(colorjam)
library(pheatmap)
library(igraph)
library(patchwork)
library(tidyr)
```


### Load custom function

```{r}
source("~/Documents/GitHub/semla_training/CellColoc.R")
```


### Set working directory

```{r}
myfolder <- "~/hdca_DevHeart/output/HDCA_heart_sc_analysis_docker/stereoscope/visualization/colocalization/"
```


### Load ST data

```{r}
ST <- readRDS("~/hdca_DevHeart/data/ST/220114_STdata_harmony_semla.rds")
```


### Add sectionID

```{r}
ST$sectionID <- GetCoordinates(ST)$sampleID
```


================================================================================
================================================================================

## Cell type co-localization

### High Level

#### Load stereoscope data and add as separate assay

```{r}
proportions <- read.table("~/hdca_DevHeart/data/ST/stereoscope/W.2023-09-25133054.715121_hl.tsv", header = TRUE, check.names = FALSE)

proportions <- proportions %>% select(-c("6", "34"))

# Check that all spot IDs are matched
all(colnames(ST) == rownames(proportions))

# Create and store assay
ST[["stereoscope"]] <- CreateAssayObject(data = t(proportions))
```


#### Set default assay to `stereoscope´

```{r}
DefaultAssay(ST) <- "stereoscope"
```


### Cell type co-localization (age specific)

```{r}
ST_meta_data <- openxlsx::read.xlsx("~/hdca_DevHeart/data/ST/HDCA_heart_ST_sections_overview_chambers_present.xlsx")
ST_meta_data$age <- as.numeric(gsub("[^0-9.]", "", ST_meta_data$Age))

ST_meta_data <- select(ST_meta_data, Section, age)
ST_meta_data
```


#### Annotate section with corresponding age

```{r}
section_age <- setNames(ST_meta_data$age, nm = ST_meta_data$Section)
ST$age <- section_age[as.character(ST$sectionID)]
```


#### Creating age groups

```{r}
ST_age1 <- ST[,ST$age <= 7.5]
ST_age2 <- ST[,ST$age == 8 | ST$age == 9]
ST_age3 <- ST[,ST$age >= 10]
```


##### Sanity check

```{r}
table(ST_age1$age)
table(ST_age2$age)
table(ST_age3$age)
```


### Deep Level

#### Load stereoscope data and add as separate assay

```{r}
proportions <- read.table("~/hdca_DevHeart/data/ST/stereoscope/W.2023-10-28105405.918149_dl.tsv", header = TRUE, check.names = FALSE)

proportions <- proportions %>% select(-c("HL_6", "HL_34"))

# Check that all spot IDs are matched
all(colnames(ST) == rownames(proportions))

# Create and store assay
ST[["stereoscope_dl"]] <- CreateAssayObject(data = t(proportions))
```


#### Pairwise correlation

#### Correlation matrix between ST and stereoscope_dl assay

```{r}
corMat <- cor(GetAssayData(ST, assay = "stereoscope_dl", slot = "data") |> t())
dim(corMat)
```


```{r}
DefaultAssay(ST) <- "stereoscope_dl"
ST
```


#### Set diagonal to NA

```{r}
diag(corMat) <- NA
```


#### Histogram of co-detection scores distribution

```{r}
# Set the number of bins based on your preference
num_bins <- 30

#corMat is simetrocal. Take only 1 side of the diagonal
corValues <- corMat[upper.tri(corMat, diag = TRUE)]

# Create a histogram with bins and plot it
hist(corValues, breaks = num_bins, col = "skyblue", border = "black", xlab = "Co-detection Score", ylab = "Frequency", main = "Distribution of Co-Detection Scores")
```


#### Check if it is normal distribution

```{r}
qqnorm(corValues, main='Normal')
qqline(corValues)
```

```{r}
shapiro.test(corValues)
```

```{r}
ks.test(corValues, 'pnorm')
```

Scores not normally distributed.
Check quantile

#### Quantile

```{r}
corValues_mt_noNA <- drop_na(as.data.frame(corValues))
quantile(corValues_mt_noNA$corValues)
quantile(corValues_mt_noNA$corValues, probs = c(0.77, 0.8, 0.85 ,0.9, 0.95, 0.97, 0.99))
```

         0%          25%          50%          75%         100% 
-0.195686001 -0.035280750 -0.009623884  0.017547475  0.416102900 

       77%        80%        85%        90%        95%        97%        99% 
0.02055264 0.02603766 0.03970846 0.06095971 0.09112172 0.12038709 0.19281356 


#### Visualization

```{r}
heatmap_colors <- colorRampPalette(RColorBrewer::brewer.pal(n = 11, name = "RdBu") |> rev())(50)
```


#### Add the annotation

```{r}
annotation <- read.csv2("~/hdca_DevHeart/data/metadata/HDCA_heart_SC_annotations_DL_240204.csv", header = 1, sep = ";")
annotation$cluster <- gsub("_", "-", annotation$cluster)
cells_clusters <- setNames(annotation$cell_type, nm = annotation$cluster)
```


#### Correlation matrix with names (Supp Tab. 7)

```{r}
corMat_annot <- corMat
colnames(corMat_annot) <- cells_clusters[as.character(colnames(corMat_annot))]
rownames(corMat_annot) <- cells_clusters[as.character(rownames(corMat_annot))]

# Save the detable as a csv file.
write.csv2(corMat_annot, paste0("~/hdca_DevHeart/output/HDCA_heart_sc_analysis_docker/", "supplementary_tables/supplementary_table_7_corMat_DL.csv"))
```


#### Correlation heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- colnames(corMat)[clusters$order] # Fetch rearranged cell type labels

# Pivot corMat to long data format
cors <- tidyr::pivot_longer(corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_all.pdf"), width = 30, height = 30)
p
dev.off()
```


#### Correlation heatmap with ggplot2 - no label (Fig. 7A)

```{r}
# Cluster data for arrangement
distMat <- dist(corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- colnames(corMat)[clusters$order] # Fetch rearranged cell type labels

# Pivot corMat to long data format
cors <- tidyr::pivot_longer(corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  #geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) + # Remove panel borders
  labs(x = "", y = "")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_all_no_label.pdf"), width = 30, height = 30)
p
dev.off()
```


### Niches

#### Heatmap of niches (Fig. 7B, 7D, Supp Fig. 7C)

```{r}
niches <- list(
               c("CM-19-2", "CM-19-1", "FB-17", "EN-18", "EN-16"), #(Fig. 7B)
               c("EN-17", "EN-7", "FB-4", "FB-13", "FB-11", "CM-8-2"), #(Fig. 7C)
               c("HL-15", "EN-20", "FB-1", "FB-6", "HL-8", "EN-19", "HL-10", "EN-15")) #(Supp. Fig 7C)

for (niche in niches){
  heatmap_name <- paste0("niche_", paste(niche, collapse = "_"))
  print(heatmap_name)
  
  split_corMat <- corMat[niche, 
                        niche]
  
  #plot
  # Cluster data for arrangement
  distMat <- dist(split_corMat, method = "euclidean") # Compute distance matrix
  clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
  cluster_levels <- niche
  
  # Pivot split_corMat to long data format
  cors <- tidyr::pivot_longer(split_corMat |> 
                                as.data.frame() |> 
                                tibble::rownames_to_column(var = "celltype"), where(is.numeric))
  
  # Set factor levels
  cors <- cors |> 
    mutate(name = factor(name, levels = cluster_levels),
           celltype = factor(celltype, levels = cluster_levels))
  
  # Calculate the absolute max value to define the limits of the fill scale
  max_val_abs <- max(abs(split_corMat), na.rm = TRUE)
  
  p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
    geom_tile() + # Use geom_tile to create the heatmap
    geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
    scale_y_discrete(limits = rev) + # Flip y axis
    scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
    theme(panel.grid = element_blank(),
          axis.text.x = element_text(angle = 90)) + # Remove panel borders
    labs(x = "cell type", y = "cell type")
  #p
  
  pdf(file = paste0(myfolder, "heatmaps/niche_colocalization_dl_", heatmap_name, ".pdf"), width = 10, height = 10)
  print(p)
  dev.off()
}
```


### Cell type co-localization (age specific)

#### Creating age groups

```{r}
ST_age1 <- ST[,ST$age <= 7.5]
ST_age2 <- ST[,ST$age == 8 | ST$age == 9]
ST_age3 <- ST[,ST$age >= 10]
```


##### Sanity check

```{r}
table(ST_age1$age)
table(ST_age2$age)
table(ST_age3$age)
```


### ST_age1 - Pairwise correlation

#### Correlation matrix between ST and stereoscope assay

```{r}
corMat <- cor(GetAssayData(ST_age1, assay = "stereoscope_dl", slot = "data") |> t())
dim(corMat)
```


#### Set diagonal to NA

```{r}
diag(corMat) <- NA
```


#### Histogram of co-detection scores distribution

```{r}
# Set the number of bins based on your preference
num_bins <- 30

#corMat is simetrocal. Take only 1 side of the diagonal
corValues <- corMat[upper.tri(corMat, diag = TRUE)]

# Create a histogram with bins and plot it
hist(corValues, breaks = num_bins, col = "skyblue", border = "black", xlab = "Co-detection Score", ylab = "Frequency", main = "Distribution of Co-Detection Scores")
```


#### Check if it is normal distribution

```{r}
qqnorm(corValues, main='Normal')
qqline(corValues)
```

```{r}
shapiro.test(corValues)
```

```{r}
ks.test(corValues, 'pnorm')
```

Scores not normally distributed.
Check quantile


#### Quantile

```{r}
corValues_mt_noNA_1 <- drop_na(as.data.frame(corValues))
```


#### Visualization

```{r}
heatmap_colors <- colorRampPalette(RColorBrewer::brewer.pal(n = 11, name = "RdBu") |> rev())(50)
```


#### Correlation heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- colnames(corMat)[clusters$order] # Fetch rearranged cell type labels

# Pivot corMat to long data format
cors <- tidyr::pivot_longer(corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_age1.pdf"), width = 30, height = 30)
p
dev.off()
```


#### Correlation heatmap with ggplot2 - no label

```{r}
# Cluster data for arrangement
distMat <- dist(corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- colnames(corMat)[clusters$order] # Fetch rearranged cell type labels

# Pivot corMat to long data format
cors <- tidyr::pivot_longer(corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  #geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) + # Remove panel borders
  labs(x = "", y = "")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_age1_no_label.pdf"), width = 30, height = 30)
p
dev.off()
```


#### Niche 1 "CM-18","CM-4-2", "CM-4-1", "EN-1", "EN-12" (Supp Fig. 7B)

```{r}
niche <- c("CM-18","CM-4-2", "CM-4-1", "EN-1", "EN-12")
split_corMat <- corMat[niche, 
                      niche]

#plot
# Cluster data for arrangement
distMat <- dist(split_corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- niche

# Pivot split_corMat to long data format
cors <- tidyr::pivot_longer(split_corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(split_corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/niche_colocalization_dl_", "CM-18_CM-4-2_CM-4-1_EN-1_EN-12", "_age1", ".pdf"), width = 10, height = 10)
print(p)
dev.off()
```


#### Niche 2 "EN-19", "EN-15", "EN-13", "EN-10", "EN-2" (Supp Fig. 7D)

```{r}
niche <- c("EN-19", "EN-15", "EN-13", "EN-10", "EN-2")
split_corMat <- corMat[niche, 
                      niche]

#plot
# Cluster data for arrangement
distMat <- dist(split_corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- niche

# Pivot split_corMat to long data format
cors <- tidyr::pivot_longer(split_corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(split_corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/niche_colocalization_dl_", "EN-19_EN-15_EN-13_EN-10_EN-2", "_age1", ".pdf"), width = 10, height = 10)
print(p)
dev.off()
```


### ST_age2 - Pairwise correlation

#### Correlation matrix between ST and stereoscope assay

```{r}
corMat <- cor(GetAssayData(ST_age2, assay = "stereoscope_dl", slot = "data") |> t())
dim(corMat)
```


#### Set diagonal to NA

```{r}
diag(corMat) <- NA
```


#### Histogram of co-detection scores distribution

```{r}
# Set the number of bins based on your preference
num_bins <- 30

#corMat is simetrocal. Take only 1 side of the diagonal
corValues <- corMat[upper.tri(corMat, diag = TRUE)]

# Create a histogram with bins and plot it
hist(corValues, breaks = num_bins, col = "skyblue", border = "black", xlab = "Co-detection Score", ylab = "Frequency", main = "Distribution of Co-Detection Scores")
```


#### Check if it is normal distribution

```{r}
qqnorm(corValues, main='Normal')
qqline(corValues)
```

```{r}
shapiro.test(corValues)
```

```{r}
ks.test(corValues, 'pnorm')
```

Scores not normally distributed.
Check quatiles

#### Quantile

```{r}
corValues_mt_noNA_2 <- drop_na(as.data.frame(corValues))
```


#### Visualization

```{r}
heatmap_colors <- colorRampPalette(RColorBrewer::brewer.pal(n = 11, name = "RdBu") |> rev())(50)
```


#### Correlation heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- colnames(corMat)[clusters$order] # Fetch rearranged cell type labels

# Pivot corMat to long data format
cors <- tidyr::pivot_longer(corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_age2.pdf"), width = 30, height = 30)
p
dev.off()
```


#### Correlation heatmap with ggplot2 - no label

```{r}
# Cluster data for arrangement
distMat <- dist(corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- colnames(corMat)[clusters$order] # Fetch rearranged cell type labels

# Pivot corMat to long data format
cors <- tidyr::pivot_longer(corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  #geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) + # Remove panel borders
  labs(x = "", y = "")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_age2_no_label.pdf"), width = 30, height = 30)
p
dev.off()
```


#### Niche 1 "CM-18","CM-4-2", "CM-4-1", "EN-1", "EN-12" (Supp Fig. 7B)

```{r}
niche <- c("CM-18","CM-4-2", "CM-4-1", "EN-1", "EN-12")
split_corMat <- corMat[niche, 
                      niche]

#plot
# Cluster data for arrangement
distMat <- dist(split_corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- niche

# Pivot split_corMat to long data format
cors <- tidyr::pivot_longer(split_corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(split_corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/niche_colocalization_dl_", "CM-18_CM-4-2_CM-4-1_EN-1_EN-12", "_age2", ".pdf"), width = 10, height = 10)
print(p)
dev.off()
```


#### Niche 2 "EN-19", "EN-15", "EN-13", "EN-10", "EN-2" (Supp Fig. 7D)

```{r}
niche <- c("EN-19", "EN-15", "EN-13", "EN-10", "EN-2")
split_corMat <- corMat[niche, 
                      niche]

#plot
# Cluster data for arrangement
distMat <- dist(split_corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- niche

# Pivot split_corMat to long data format
cors <- tidyr::pivot_longer(split_corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(split_corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/niche_colocalization_dl_", "EN-19_EN-15_EN-13_EN-10_EN-2", "_age2", ".pdf"), width = 10, height = 10)
print(p)
dev.off()
```


### ST_age3 - Pairwise correlation

#### Correlation matrix between ST and stereoscope assay

```{r}
corMat <- cor(GetAssayData(ST_age3, assay = "stereoscope_dl", slot = "data") |> t())
dim(corMat)
```


#### Set diagonal to NA

```{r}
diag(corMat) <- NA
```


#### Histogram of co-detection scores distribution

```{r}
# Set the number of bins based on your preference
num_bins <- 30

#corMat is simetrocal. Take only 1 side of the diagonal
corValues <- corMat[upper.tri(corMat, diag = TRUE)]

# Create a histogram with bins and plot it
hist(corValues, breaks = num_bins, col = "skyblue", border = "black", xlab = "Co-detection Score", ylab = "Frequency", main = "Distribution of Co-Detection Scores")
```


#### Check if it is normal distribution

```{r}
qqnorm(corValues, main='Normal')
qqline(corValues)
```

```{r}
shapiro.test(corValues)
```

```{r}
ks.test(corValues, 'pnorm')
```

Scores not normally distributed.
Check quantile


#### Quantile

```{r}
corValues_mt_noNA_3 <- drop_na(as.data.frame(corValues))
```


### Quantile 3 age groupes together

```{r}
corValues_mt_noNA_df <- data.frame( 
                              c(corValues_mt_noNA_1$corValues,
                              corValues_mt_noNA_2$corValues,
                              corValues_mt_noNA_3$corValues))
colnames(corValues_mt_noNA_df) <- c("corValues")

quantile(corValues_mt_noNA_df$corValues)
quantile(corValues_mt_noNA_df$corValues, probs = c(0.77, 0.8, 0.85 ,0.9, 0.95, 0.97, 0.99))
```

         0%         25%         50%         75%        100% 
-0.25286118 -0.03575034 -0.01014964  0.01969635  0.55382266 

       77%        80%        85%        90%        95%        97%        99% 
0.02307011 0.02908228 0.04180005 0.06182540 0.10313991 0.13640610 0.20345035 


#### Visualization

```{r}
heatmap_colors <- colorRampPalette(RColorBrewer::brewer.pal(n = 11, name = "RdBu") |> rev())(50)
```


#### Correlation heatmap with ggplot2

```{r}
# Cluster data for arrangement
distMat <- dist(corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- colnames(corMat)[clusters$order] # Fetch rearranged cell type labels

# Pivot corMat to long data format
cors <- tidyr::pivot_longer(corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_age3.pdf"), width = 30, height = 30)
p
dev.off()
```


#### Correlation heatmap with ggplot2 - no label

```{r}
# Cluster data for arrangement
distMat <- dist(corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- colnames(corMat)[clusters$order] # Fetch rearranged cell type labels

# Pivot corMat to long data format
cors <- tidyr::pivot_longer(corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  #geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank()) + # Remove panel borders
  labs(x = "", y = "")
p

pdf(file = paste0(myfolder, "heatmaps/colocalization_dl_age3_no_label.pdf"), width = 30, height = 30)
p
dev.off()
```


#### Niche 1 "CM-18","CM-4-2", "CM-4-1", "EN-1", "EN-12" (Supp Fig. 7B)

```{r}
niche <- c("CM-18","CM-4-2", "CM-4-1", "EN-1", "EN-12")
split_corMat <- corMat[niche, 
                      niche]

#plot
# Cluster data for arrangement
distMat <- dist(split_corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- niche

# Pivot split_corMat to long data format
cors <- tidyr::pivot_longer(split_corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(split_corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/niche_colocalization_dl_", "CM-18_CM-4-2_CM-4-1_EN-1_EN-12", "_age3", ".pdf"), width = 10, height = 10)
print(p)
dev.off()
```


#### Niche 2 "EN-19", "EN-15", "EN-13", "EN-10", "EN-2" (Supp Fig. 7D)

```{r}
niche <- c("EN-19", "EN-15", "EN-13", "EN-10", "EN-2")
split_corMat <- corMat[niche, 
                      niche]

#plot
# Cluster data for arrangement
distMat <- dist(split_corMat, method = "euclidean") # Compute distance matrix
clusters <- hclust(distMat, method = "complete") # Cluster distance matrix
cluster_levels <- niche

# Pivot split_corMat to long data format
cors <- tidyr::pivot_longer(split_corMat |> 
                              as.data.frame() |> 
                              tibble::rownames_to_column(var = "celltype"), where(is.numeric))

# Set factor levels
cors <- cors |> 
  mutate(name = factor(name, levels = cluster_levels),
         celltype = factor(celltype, levels = cluster_levels))

# Calculate the absolute max value to define the limits of the fill scale
max_val_abs <- max(abs(split_corMat), na.rm = TRUE)

p <- ggplot(cors, aes(x = celltype, y = name, fill = value)) +
  geom_tile() + # Use geom_tile to create the heatmap
  geom_text(aes(label = round(value, 2)), vjust = 1, size = 3) + # Add numerical values on top of each cells
  scale_y_discrete(limits = rev) + # Flip y axis
  scale_fill_gradientn(colours = heatmap_colors, limit = c(-max_val_abs, max_val_abs)) + # Set fill scale limits using max_val_abs
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90)) + # Remove panel borders
  labs(x = "cell type", y = "cell type")
p

pdf(file = paste0(myfolder, "heatmaps/niche_colocalization_dl_", "EN-19_EN-15_EN-13_EN-10_EN-2", "_age3", ".pdf"), width = 10, height = 10)
print(p)
dev.off()
```


================================================================================
================================================================================

## Network correlation graph

From the correlation about cell types co-localization, plot a network graph instead of the heatmaps for simplify visualization.

### High Level

```{r}
set.seed(1)
corMat_network <- cor(GetAssayData(ST, assay = "stereoscope", slot = "data") |> t())
corMat_network[corMat_network<0.04] <- 0
network <- graph_from_adjacency_matrix(corMat_network, weighted=T, mode="undirected", diag=F)

# Count the number of degree for each node:
deg <- degree(network, mode="all")
 
# Plot
plot(network, vertex.size=deg*2, vertex.color=rgb(0.1,0.7,0.8,0.5))
```


### Deep Level

```{r}
DefaultAssay(ST_age1) <- "stereoscope_dl"
DefaultAssay(ST_age2) <- "stereoscope_dl"
DefaultAssay(ST_age3) <- "stereoscope_dl"
```


#### Cell types to exclude from the network graph

```{r}
cell_types_to_exclude <- c("CM-5", "CM-17", "EN-5", "FB-2", "FB-12", "IN-11", "IN-12", "IN-17", "IN-3", "IN-4", "IN-7")
```


#### ST deep level all ages (Supp Fig. 7A)

```{r}
set.seed(1)

DefaultAssay(ST) <- "stereoscope_dl"

# Subset ST object for cell types of interest
ST_nw <- ST[!(rownames(ST) %in% cell_types_to_exclude), ]

# Calculate Pearson's correlation scores for remaining cell types
corMat_network <- cor(GetAssayData(ST_nw, assay = "stereoscope_dl", slot = "data") |> t())

# Keep Pearson's scores above threshold (can't work with negative scores)
corMat_network[corMat_network<0.070] <- 0

# Generate network graph based on the remaining correlation score
network <- graph_from_adjacency_matrix(corMat_network, weighted=T, mode="undirected", diag=F)

# Count the number of degree for each node:
deg <- degree(network, mode="all")
 
# Plot
pdf(file = paste0(myfolder, "networks/deeplevel_all_0070.pdf"), width = 10, height = 10)
plot(network, vertex.size=deg*1.1, vertex.color=rgb(0.1,0.7,0.8,0.5))
dev.off()
```


#### ST_age1

```{r}
set.seed(1)

# Subset ST object for cell types of interest
ST_age1_nw <- ST_age1[!(rownames(ST_age1) %in% cell_types_to_exclude), ]

# Calculate Pearson's correlation scores for remaining cell types
corMat_network <- cor(GetAssayData(ST_age1_nw, assay = "stereoscope_dl", slot = "data") |> t())

# Keep Pearson's scores above threshold (can't work with negative scores)
corMat_network[corMat_network<0.070] <- 0

# Generate network graph based on the remaining correlation score
network <- graph_from_adjacency_matrix(corMat_network, weighted=T, mode="undirected", diag=F)

# Count the number of degree for each node:
deg <- degree(network, mode="all")
 
# Plot
pdf(file = paste0(myfolder, "networks/deeplevel_age1_0070.pdf"), width = 10, height = 10)
plot(network, vertex.size=deg*1.1, vertex.color=rgb(0.1,0.7,0.8,0.5))
dev.off()
```


#### ST_age2

```{r}
set.seed(1)

# Subset ST object for cell types of interest
ST_age2_nw <- ST_age2[!(rownames(ST_age2) %in% cell_types_to_exclude), ]

# Calculate Pearson's correlation scores for remaining cell types
corMat_network <- cor(GetAssayData(ST_age2_nw, assay = "stereoscope_dl", slot = "data") |> t())

# Keep Pearson's scores above threshold (can't work with negative scores)
corMat_network[corMat_network<0.070] <- 0

# Generate network graph based on the remaining correlation score
network <- graph_from_adjacency_matrix(corMat_network, weighted=T, mode="undirected", diag=F)

# Count the number of degree for each node:
deg <- degree(network, mode="all")
 
# Plot
pdf(file = paste0(myfolder, "networks/deeplevel_age2_0070.pdf"), width = 10, height = 10)
plot(network, vertex.size=deg*1.1, vertex.color=rgb(0.1,0.7,0.8,0.5))
dev.off()
```


#### ST_age3

```{r}
set.seed(1)

# Subset ST object for cell types of interest
ST_age3_nw <- ST_age3[!(rownames(ST_age3) %in% cell_types_to_exclude), ]

# Calculate Pearson's correlation scores for remaining cell types
corMat_network <- cor(GetAssayData(ST_age3_nw, assay = "stereoscope_dl", slot = "data") |> t())

# Keep Pearson's scores above threshold (can't work with negative scores)
corMat_network[corMat_network<0.070] <- 0

# Generate network graph based on the remaining correlation score
network <- graph_from_adjacency_matrix(corMat_network, weighted=T, mode="undirected", diag=F)

# Count the number of degree for each node:
deg <- degree(network, mode="all")
 
# Plot
pdf(file = paste0(myfolder, "networks/deeplevel_age3_0070.pdf"), width = 10, height = 10)
plot(network, vertex.size=deg*1.1, vertex.color=rgb(0.1,0.7,0.8,0.5))
dev.off()
```


================================================================================
================================================================================

## CO-LOCALIZATION

### Set default assay to `stereoscope_dl´

```{r}
DefaultAssay(ST) <- "stereoscope_dl"
ST
```

### Fig 3

#### "CM-19-1", "CM-19-2", sc. 16 (Fig. 3C)

```{r}
plots <- CellColoc(ST,
                      features = c("CM-19-1", "CM-19-2"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/CM-19-1_CM-19-2_section_16.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


#### "CM-4-2", "CM-4-1" - 4 different sections (Supp Fig. 3C)

```{r}
# time point 1
plots1 <- CellColoc(ST,
                      features = c("CM-4-2", "CM-4-1"),
                      section_number = 5)

# time point 2
plots2 <- CellColoc(ST, 
                      features = c("CM-4-2", "CM-4-1"),
                      section_number = 2)

# time point 3
plots3 <- CellColoc(ST, 
                      features = c("CM-4-2", "CM-4-1"),
                      section_number = 11)

# time point 4
plots4 <- CellColoc(ST, 
                      features = c("CM-4-2", "CM-4-1"),
                      section_number = 24)

p <- plots1[[3]] + plots2[[3]] + plots3[[3]] + plots4[[3]]  +
    patchwork::plot_layout(ncol = 4)

pdf(file = paste0(myfolder, "colocalization/CM-4-2_CM-4-1.pdf"), width = 15.75, height = 4.5)
p
dev.off()
```


#### "CM-4-2", "CM-18", sc. 16 (Fig. 3C)

```{r}
plots <- CellColoc(ST,
                      features = c("CM-4-2", "CM-18"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/CM-4-2_CM-18_section_16.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


#### "CM-8-2", "CM-18", "CM-19-1", in sc. 3 (Supp Fig. 3E)

```{r}
plots <- CellColoc3(ST,
                      features = c("CM-8-2", "CM-18", "CM-19-1"),
                      section_number = 3)

pdf(file = paste0(myfolder, "colocalization/CM-8-2_CM-18_CM-19-1_section_3.pdf"), width = 20, height = 6)
plots
dev.off()
```


### Fig 4

#### "IN-13", "CM-19-2", "IN-1", sc. 16 (Fig. 4E)

```{r}
plots <- CellColoc3(ST,
                      features = c("IN-13", "CM-19-2", "IN-1"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/IN-13_CM-19-2_IN-1_section_16.pdf"), width = 20, height = 6)
plots
dev.off()
```


####  "IN-13", "CM-14", "IN-1"  in sc. 22 (Supp Fig. 4B)

```{r}
plots <- CellColoc3(ST,
                      features = c("IN-13", "CM-14", "IN-1"),
                      section_number = 22)

pdf(file = paste0(myfolder, "colocalization/IN-13_CM-14_IN-1_section_22.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "IN-13",  "FB-1",  "IN-1"   in sc. 32 and 34 (Supp Fig. 4B)

```{r}
plots <- CellColoc3(ST,
                      features = c("IN-13",  "FB-1",  "IN-1"),
                      section_number = 32)

pdf(file = paste0(myfolder, "colocalization/IN-13_FB-1_IN-1_section_32.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("IN-13",  "FB-1",  "IN-1"),
                      section_number = 34)

pdf(file = paste0(myfolder, "colocalization/IN-13_FB-1_IN-1_section_34.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "IN-8", "IN-19", sc. 16 (Supp Fig. 4C)

```{r}
plots <- CellColoc(ST,
                      features = c("IN-8", "IN-19"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/IN-8_IN-19_section_16.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


### Fig 5

#### "EN-7", "EN-17", sc. 2, 20 (Fig. 5B)

```{r}
plots <- CellColoc(ST,
                      features = c("EN-7", "EN-17"),
                      section_number = 2)

pdf(file = paste0(myfolder, "colocalization/EN-7_EN-17_section_2.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```

```{r}
plots <- CellColoc(ST,
                      features = c("EN-7", "EN-17"),
                      section_number = 20)

pdf(file = paste0(myfolder, "colocalization/EN-7_EN-17_section_20.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


#### "CM-9", "CM-14", "EN-18", sc. 27 (Fig. 5C)

```{r}
plots <- CellColoc3(ST,
                      features = c("CM-9", "CM-14", "EN-18"),
                      section_number = 27)

pdf(file = paste0(myfolder, "colocalization/CM-9_CM-14_EN-18_section_27.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "EN-7", "EN-17", sc. 6 (Supp Fig. 5D)

```{r}
plots <- CellColoc(ST,
                      features = c("EN-7", "EN-17"),
                      section_number = 6)

pdf(file = paste0(myfolder, "colocalization/EN-7_EN-17_section_6.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


#### "EN-6", "EN-18", "EN-16", sc. 18 (Supp Fig. 5E)

```{r}
plots <- CellColoc3(ST,
                      features = c("EN-6", "EN-18", "EN-16"),
                      section_number = 18)

pdf(file = paste0(myfolder, "colocalization/EN-6_EN-18_EN-16_section_18.pdf"), width = 20, height = 6)
plots
dev.off()
```


### Fig 6

#### "FB-1", "FB-6" sc. 9, 16 (Fig. 6B)

```{r}
plots <- CellColoc(ST,
                      features = c("FB-1", "FB-6"),
                      section_number = 9)

pdf(file = paste0(myfolder, "colocalization/FB-1_FB-6_section_9.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```

```{r}
plots <- CellColoc(ST,
                      features = c("FB-1", "FB-6"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/FB-1_FB-6_section_16.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


#### "FB-15", "HL-22", sc. 9, 10, 33 (Fig. 6B) (Supp Fig. 7F)

```{r}
plots <- CellColoc(ST,
                      features = c("FB-15", "HL-22"),
                      section_number = 9)

pdf(file = paste0(myfolder, "colocalization/FB-15_HL-22_section_9.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```

```{r}
plots <- CellColoc(ST,
                      features = c("FB-15", "HL-22"),
                      section_number = 10)

pdf(file = paste0(myfolder, "colocalization/FB-15_HL-22_section_10.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```

```{r}
plots <- CellColoc(ST,
                      features = c("FB-15", "HL-22"),
                      section_number = 33)

pdf(file = paste0(myfolder, "colocalization/FB-15_HL-22_section_33.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


#### "HL-20", "FB-7", "FB-3" sc.11 (Fig. 6C)

```{r}
plots <- CellColoc3(ST,
                      features = c("HL-20", "FB-7", "FB-3"),
                      section_number = 11)

pdf(file = paste0(myfolder, "colocalization/HL-20_FB-7_FB-3_section_11.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "FB-7", "FB-8", "FB-14", sc. 23 (Fig. 6C)

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-7", "FB-8", "FB-14"),
                      section_number = 23)

pdf(file = paste0(myfolder, "colocalization/FB-7_FB-8_FB-14_section_23.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "FB-4", "FB-11", "FB-13", sc. 2, 20, 22, 33 (Fig. 6D)

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-4", "FB-11", "FB-13"),
                      section_number = 2)

pdf(file = paste0(myfolder, "colocalization/FB-4_FB-11_FB-13_section_2.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "FB-5", "FB-9", "FB-19", sc. 5, 2, 11, 24 (Fig. 6D)

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-5", "FB-9", "FB-19"),
                      section_number = 5)

pdf(file = paste0(myfolder, "colocalization/FB-5_FB-9_FB-19_section_5.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-5", "FB-9", "FB-19"),
                      section_number = 2)

pdf(file = paste0(myfolder, "colocalization/FB-5_FB-9_FB-19_section_2.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-5", "FB-9", "FB-19"),
                      section_number = 11)

pdf(file = paste0(myfolder, "colocalization/FB-5_FB-9_FB-19_section_11.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-5", "FB-9", "FB-19"),
                      section_number = 24)

pdf(file = paste0(myfolder, "colocalization/FB-5_FB-9_FB-19_section_24.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "FB-4", "FB-11", "FB-13", sc.22 (Fig. 6E)

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-4", "FB-11", "FB-13"),
                      section_number = 22)

pdf(file = paste0(myfolder, "colocalization/FB-4_FB-11_FB-13_section_22.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "FB-4", "FB-11", "FB-13", sc.20 (Supp Fig. 6F)

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-4", "FB-11", "FB-13"),
                      section_number = 20)

pdf(file = paste0(myfolder, "colocalization/FB-4_FB-11_FB-13_section_20.pdf"), width = 20, height = 6)
plots
dev.off()
```


### Fig 7

#### "CM-19-2", "CM-19-1", "FB-17", sc. 19 (Fig. 7B)

```{r}
plots <- CellColoc3(ST,
                      features = c("CM-19-2", "CM-19-1", "FB-17"),
                      section_number = 19)

pdf(file = paste0(myfolder, "colocalization/CM-19-2_CM-19-1_FB-17_section_19.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "EN-16", "EN-18", in sc. 19 (Fig. 7B)

```{r}
plots <- CellColoc3(ST,
                      features = c("EN-16", "EN-18", "CM-19-1"),
                      section_number = 19)

pdf(file = paste0(myfolder, "colocalization/EN-16_EN-18_section_19.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "EN-7", "EN-17", "FB-4", sc. 20 (Fig. 7D)

```{r}
plots <- CellColoc3(ST,
                      features = c("EN-7", "EN-17", "FB-4"),
                      section_number = 20)

pdf(file = paste0(myfolder, "colocalization/EN-7_EN-17_FB-4_section_20.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "FB-11", "FB-13", "CM-8-2", sc. 20 (Fig. 7D)

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-11", "FB-13", "CM-8-2"),
                      section_number = 20)

pdf(file = paste0(myfolder, "colocalization/FB-11_FB-13_CM-8-2_section_20.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "FB-6", "HL-10", "EN-15", sc. 20 (Supp Fig. 7C)

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-6", "HL-10", "EN-15"),
                      section_number = 20)

pdf(file = paste0(myfolder, "colocalization/FB-6_HL-10_EN-15_section_20.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "FB-1", "HL-15", "EN-20", sc. 20 (Supp Fig. 7C)

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-1", "HL-15", "EN-20"),
                      section_number = 20)

pdf(file = paste0(myfolder, "colocalization/FB-1_HL-15_EN-20_section_20.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "FB-1", "HL-8", "EN-19", sc.20 (Supp Fig. 7C)

```{r}
plots <- CellColoc3(ST,
                      features = c("FB-1", "HL-8", "EN-19"),
                      section_number = 20)

pdf(file = paste0(myfolder, "colocalization/FB-1_HL-8_EN-19_section_20.pdf"), width = 20, height = 6)
plots
dev.off()
```


### Reviewer's answers

#### "CM-19-1", "CM-18", "CM-4-2", sc. 3, 4

```{r}
plots <- CellColoc3(ST,
                      features = c("CM-19-1", "CM-18", "CM-4-2"),
                      section_number = 3)

pdf(file = paste0(myfolder, "colocalization/CM-19-1_CM-18_CM-4-2_section_3.pdf"), width = 20, height = 6)
plots
dev.off()
```

```{r}
plots <- CellColoc3(ST,
                      features = c("CM-19-1", "CM-18", "CM-4-2"),
                      section_number = 4)

pdf(file = paste0(myfolder, "colocalization/CM-19-1_CM-18_CM-4-2_section_4.pdf"), width = 20, height = 6)
plots
dev.off()
```


#### "CM-19-2", "CM-19-1", sc. 16, 18, 19, 27

```{r}
plots <- CellColoc(ST,
                      features = c("CM-19-2", "CM-19-1"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/CM-19-2_CM-19-1_section_16.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```

```{r}
plots <- CellColoc(ST,
                      features = c("CM-19-2", "CM-19-1"),
                      section_number = 18)

pdf(file = paste0(myfolder, "colocalization/CM-19-2_CM-19-1_section_18.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```

```{r}
plots <- CellColoc(ST,
                      features = c("CM-19-2", "CM-19-1"),
                      section_number = 19)

pdf(file = paste0(myfolder, "colocalization/CM-19-2_CM-19-1_section_19.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```

```{r}
plots <- CellColoc(ST,
                      features = c("CM-19-2", "CM-19-1"),
                      section_number = 27)

pdf(file = paste0(myfolder, "colocalization/CM-19-2_CM-19-1_section_27.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


#### "CM-18", "CM-4-2", sc. 27, 16, 18, 19

```{r}
plots <- CellColoc(ST,
                      features = c("CM-18", "CM-4-2"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/CM-18_CM-4-2_section_16.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```

```{r}
plots <- CellColoc(ST,
                      features = c("CM-18", "CM-4-2"),
                      section_number = 18)

pdf(file = paste0(myfolder, "colocalization/CM-18_CM-4-2_section_18.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```

```{r}
plots <- CellColoc(ST,
                      features = c("CM-18", "CM-4-2"),
                      section_number = 19)

pdf(file = paste0(myfolder, "colocalization/CM-18_CM-4-2_section_19.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```

```{r}
plots <- CellColoc(ST,
                      features = c("CM-18", "CM-4-2"),
                      section_number = 27)

pdf(file = paste0(myfolder, "colocalization/CM-18_CM-4-2_section_27.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


#### "EN-20", "HL-29", sc. 16 (Extended Fig. 3E)

```{r}
plots <- CellColoc(ST,
                      features = c("EN-20", "HL-29"),
                      section_number = 16)

pdf(file = paste0(myfolder, "colocalization/EN-20_HL-29_section_16.pdf"), width = 15.75, height = 4.5)
plots
dev.off()
```


================================================================================
================================================================================
================================================================================
================================================================================
================================================================================










