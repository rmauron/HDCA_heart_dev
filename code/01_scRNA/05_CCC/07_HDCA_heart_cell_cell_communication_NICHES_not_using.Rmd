---
title: "07_HDCA_heart_cell_cell_communication"
author: "Raphaël Mauron"
output: html_document
editor_options: 
  chunk_output_type: console
---

# HDCA heart cell cell communication - NICHES

## Set up and loading material

### Knit setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### Set environment variables

```{r}
myfolder <- "~/hdca_DevHeart/output/HDCA_heart_sc_analysis_docker/"
```


### Load data

```{r}
data <- readRDS("~/hdca_DevHeart/output/HDCA_heart_sc_analysis_docker/rds_objects/HDCA_heart_sc_full_extended.rds")
```


### Set seed

```{r}
set.seed(1)
```


### Load Libraries

```{r}
library(Seurat)
library(SeuratData)
library(SeuratWrappers)
library(NICHES)
library(dplyr)
library(ggplot2)
library(tibble)
library(viridis)
```


# DEEP LEVEL

## Create annotation file for all cells
HL stereoscope: exclude 6, 19, 27, 34

```{r}
data_curated <- data[, data$high_level_clusters %in% c("1", "2", "3", "4_35", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18_1", "18_2", "20", "21", "22", "23", "24", "25", "26", "28", "29", "30", "31", "32", "33", "34")]
```

```{r}
data_curated <- FindVariableFeatures(data_curated, nfeatures = 5000)
var.features <- data_curated@assays$RNA@var.features
```

```{r}
sampled_cells <- data_curated[[]] %>% 
  tibble::rownames_to_column(var = "barcode") %>% 
  group_by(high_level_clusters)
rm(data_curated)
```

```{r}
annotation <- sampled_cells %>% 
  select(barcode, high_level_clusters, age_groups) %>% 
  data.frame(row.names = 1)
colnames(annotation) <- c("bio_celltype", "age_groups")
```


```{r}
# Load annotations prepared earlier and filter
# CM
cardiomyocyte_clusters_keep <- c("1", "2", "3", "4-1", "4-2", "5", "6", "7", "8-1", "8-2", "8-3", "9", "10", "12", "14", "17", "18", "19-1", "19-2")
cardiomyocyte_metadata <- readRDS(paste0(myfolder, "rds_objects/cardiomyocyte_metadata.rds")) %>% 
  mutate(clusters_subset = paste0("CM_", as.character(clusters_subset))) %>%  # rename cardiomyocyte clusters by adding a prefix CM_
  mutate_if(is.factor, as.character) %>% 
  filter(clusters_subset_split %in% cardiomyocyte_clusters_keep)

# EN
endothelial_clusters_keep <- c("1", "2", "3", "5", "6", "7", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21")
endothelial_metadata <- readRDS(paste0(myfolder, "rds_objects/endothelial_metadata.rds")) %>% 
  filter(clusters_subset %in% endothelial_clusters_keep) %>% 
  mutate(clusters_subset = paste0("EN_", as.character(clusters_subset))) # rename endothelial clusters by adding a prefix EN_

# FB
fibroblasts_clusters_keep <- c("1", "2", "3", "4", "5", "6", "7", "8", "9", "11", "12", "13", "14", "15", "17", "18", "19", "20")
fibroblasts_metadata <- readRDS(paste0(myfolder, "rds_objects/fibroblasts_metadata.rds")) %>% 
  filter(clusters_subset %in% fibroblasts_clusters_keep) %>% 
  mutate(clusters_subset = paste0("FB_", as.character(clusters_subset))) # rename fibroblasts clusters by adding a prefix FB_

# IN
innervation_clusters_keep <- c("1", "3", "4", "7", "8", "11", "12", "13", "17", "19")
innervation_metadata <- readRDS(paste0(myfolder, "rds_objects/innervation_metadata.rds")) %>% 
  filter(clusters_subset %in% innervation_clusters_keep) %>% 
  mutate(clusters_subset = paste0("IN_", as.character(clusters_subset))) # rename innervation clusters by adding a prefix IN_

# Merge deep level clusters from the three different subsets
deep_clusters <- cardiomyocyte_metadata %>% 
  select(clusters_subset, clusters_subset_split) %>% # Only select clustering results
  bind_rows(endothelial_metadata %>% select(clusters_subset)) %>% # Add endothelial clusters
  bind_rows(fibroblasts_metadata %>% select(clusters_subset)) %>% # Add fibroblast clusters
  bind_rows(innervation_metadata %>% select(clusters_subset)) %>% # Add innervation clusters
  mutate(clusters_subset_split = case_when(is.na(clusters_subset_split) ~ clusters_subset, # rename cardiomyocyte clusters by adding a prefix CM_
                                           TRUE ~ paste0("CM_", clusters_subset_split)))

# Define clusters to keep
keep_clusters <- c(paste0("HL_", c("6", "8", "10", "15", "18_1", "20", "22", "29", "34")), 
                   paste0("CM_", cardiomyocyte_clusters_keep),
                   paste0("EN_", endothelial_clusters_keep),
                   paste0("FB_", fibroblasts_clusters_keep),
                   paste0("IN_", innervation_clusters_keep))


# Create a new annotations tibble
annotation_split <- annotation 
annotation_split <- annotation_split %>% 
  rownames_to_column(var = "ID") %>% 
  left_join(y = deep_clusters %>% rownames_to_column(var = "ID"), by = "ID") %>% 
  mutate(clusters_subset_split = case_when(is.na(clusters_subset_split) ~ paste0("HL_", bio_celltype),
                                           TRUE ~ clusters_subset_split)) %>% 
  filter(clusters_subset_split %in% keep_clusters) # keep selected clusters

# Convert clusters_subset_split to a factor and set order of clusters
annotation_split <- annotation_split %>% 
  mutate(clusters_subset_split = factor(clusters_subset_split, keep_clusters))

# Check overlap (sanity check)
all(annotation$ID %in% colnames(data))

rm(annotation, cardiomyocyte_metadata, deep_clusters, endothelial_metadata, fibroblasts_metadata, sampled_cells, cardiomyocyte_clusters_keep, endothelial_clusters_keep, fibroblasts_clusters_keep, keep_clusters)
gc()
```


```{r}
data <- data[, colnames(data) %in% annotation_split$ID]
data$clusters_subset_split <- as.character(annotation_split$clusters_subset_split)
```



### "IN_1", "IN_13", "CM_19-2"

```{r}
my_niche <- annotation_split[annotation_split$clusters_subset_split %in% c("IN_1", "IN_13", "CM_19-2"),]

data_niche <- data[, colnames(data) %in% my_niche$ID]

#rm(my_niche)
gc()
```


## Export data_niche as rds

```{r}
saveRDS(data_niche, file = paste0(myfolder, "rds_objects/niche_IN_1_IN_13_CM_19-2.rds"))
```



================================================================================
================================================================================
================================================================================
================================================================================

### Convert to Cell-Cell Signaling Atlas

```{r}
scc <- RunNICHES(data_niche,
                 assay = 'RNA',
                 species = 'human',
                 LR.database = 'omnipath',
                 cell_types = 'clusters_subset_split')
#rm(data_niche)
gc()
```


```{r}
NICHES <- scc$CellToCell
NICHES <- ScaleData(NICHES)
NICHES <- RunPCA(NICHES,features = rownames(NICHES))
ElbowPlot(NICHES,ndims=50)

#rm(scc)
gc()
```


```{r}
PCHeatmap(NICHES,
          dims = 1:2,
          nfeatures = 50,
          balanced = TRUE,
          cells = 100)
```


```{r}
NICHES <- RunUMAP(NICHES, dims = 1:50)
DimPlot(NICHES,reduction = 'umap',group.by = 'VectorType',label = F)# +
  #theme(legend.position = "none")
```


```{r}
# Find markers
mark <- FindAllMarkers(NICHES,
                       min.pct = 0.1,
                       only.pos = T,
                       test.use = "roc")

#GOI_niche <- mark %>% group_by(cluster) %>% top_n(10, p_val) %>% top_n(5, avg_log2FC) # p_val not found

GOI_niche <- mark %>% group_by(cluster) %>% top_n(15,myAUC)


pdf(file = paste0(myfolder, "cellcellcommunication/IN_1-IN_13-CM_19-2.pdf"), width = 100, height = 20)
DoHeatmap(NICHES,
          features = unique(GOI_niche$gene),
          label = T) + 
  scale_fill_gradientn(colors = c("grey", "white", "blue")) +
  guides(color="none")
dev.off()
```




## Imputation of the same data

```{r}
imputed <- SeuratWrappers::RunALRA(data_niche)
scc.imputed <- RunNICHES(imputed,
                 assay = 'alra',
                 species = 'human',
                 LR.database = 'omnipath',
                 cell_types = 'clusters_subset_split',
                 CellToCell = T)
NICHES_imp <- scc.imputed$CellToCell
NICHES_imp <- ScaleData(NICHES_imp)
NICHES_imp <- RunPCA(NICHES_imp,features = rownames(NICHES_imp))
ElbowPlot(NICHES_imp,ndims=50)
```

```{r}
PCHeatmap(NICHES_imp,dims = 1:6,balanced = T,cells = 100)
```

```{r}
NICHES_imp <- RunUMAP(NICHES_imp,dims = 1:6)
DimPlot(NICHES_imp,reduction = 'umap',group.by = 'VectorType',label = F)
```

```{r}
DimPlot(NICHES,reduction = 'umap',group.by = 'VectorType',label = F) | DimPlot(NICHES_imp,reduction = 'umap',group.by = 'VectorType',label = F)
```

```{r}
# Find markers
mark_imp <- FindAllMarkers(NICHES_imp,min.pct = 0.1,only.pos = T,test.use = "roc")

write.csv2(mark_imp, paste0(myfolder, "cellcellcommunication/table_mark_imp_IN-1_IN-13_CM-19-2.csv"))

GOI_niche_imp <- mark_imp %>% group_by(cluster) %>% top_n(5,myAUC)

pdf(file = paste0(myfolder, "cellcellcommunication/IN_1-IN_13-CM_19-2.pdf"), width = 15, height = 10)
DoHeatmap(NICHES_imp,
          features = unique(GOI_niche_imp$gene),
          group.colors = viridis(n=9),
          size = 3,
          angle = 25,
          draw.lines = F,
          lines.width = NULL,
          raster = F) + 
  scale_fill_viridis_c()
dev.off()
```



### Split NICHES by age groups

```{r}
NICHES_1 <- NICHES[, NICHES$age_groups.Sending == "5-6"]
NICHES_2 <- NICHES[, NICHES$age_groups.Sending == "7-8"]
NICHES_3 <- NICHES[, NICHES$age_groups.Sending == "9-11"]
NICHES_4 <- NICHES[, NICHES$age_groups.Sending == "12-14"]


pdf(file = paste0(myfolder, "cellcellcommunication/HL-8_EN-19_HL-10_age_1.pdf"), width = 20, height = 20)
DoHeatmap(NICHES_1,
          features = unique(GOI_niche$gene)) + 
  scale_fill_gradientn(colors = c("grey", "white", "blue")) +
  guides(color="none")
dev.off()

pdf(file = paste0(myfolder, "cellcellcommunication/HL-8_EN-19_HL-10_age_2.pdf"), width = 20, height = 20)
DoHeatmap(NICHES_2,
          features = unique(GOI_niche$gene)) + 
  scale_fill_gradientn(colors = c("grey", "white", "blue")) +
  guides(color="none")
dev.off()

pdf(file = paste0(myfolder, "cellcellcommunication/HL-8_EN-19_HL-10_age_3.pdf"), width = 20, height = 20)
DoHeatmap(NICHES_3,
          features = unique(GOI_niche$gene)) + 
  scale_fill_gradientn(colors = c("grey", "white", "blue")) +
  guides(color="none")
dev.off()

pdf(file = paste0(myfolder, "cellcellcommunication/HL-8_EN-19_HL-10_age_4.pdf"), width = 20, height = 20)
DoHeatmap(NICHES_4,
          features = unique(GOI_niche$gene)) + 
  scale_fill_gradientn(colors = c("grey", "white", "blue")) +
  guides(color="none")
dev.off()
```


================================================================================
================================================================================

# Accross conditions

## Load Data and Explore Metadata

```{r}
data_niche

# show experimental condition as rows, cell types as columns
table(data_niche$age_groups, data_niche$clusters_subset_split)
```


## Split by Experimental Contion

```{r}
# Set idents so that celltypes are in active identity slot
Idents(data_niche) <- data_niche@meta.data["clusters_subset_split"]

# Split object into STIM and CTRL conditions, to calculate NICHES objects separately
data.list <- SplitObject(data_niche, split.by="age_groups")
# Make sure that data is normalized

data.list <- lapply(X = data.list, FUN = function(x) {
    x <- NormalizeData(x)
})
```


## Run NICHES

```{r}
# Run NICHES on each system and store/name the outputs
scc.list <- list()
for(i in 1:length(data.list)){
  print(i)
  scc.list[[i]] <- RunNICHES(data.list[[i]],
                             LR.database="omnipath",
                             species="human",
                             assay="RNA",
                             cell_types = "clusters_subset_split",
                             min.cells.per.ident=1,
                             min.cells.per.gene = 50,
                             meta.data.to.map = c('orig.ident','clusters_subset_split','age_groups'),
                             SystemToCell = T,
                             CellToCell = T)
}
#> [1] 1
#> [1] 2
names(scc.list) <- names(data.list)
```


## Isolate Output of Interest (CellToCell Signaling)

```{r}
temp.list <- list()
for(i in 1:length(scc.list)){
temp.list[[i]] <- scc.list[[i]]$CellToCell # Isolate CellToCell Signaling, which is all that will be covered in this vignette
temp.list[[i]]$Condition <- names(scc.list)[i] # Tag with metadata
}
```


## Merge and Clean

```{r}
# Merge together
scc.merge <- merge(x = temp.list[[1]], y = c(temp.list[[2]], temp.list[[3]], temp.list[[4]]))

scc.merge$Condition <- factor(scc.merge$Condition, levels = c("5-6", "7-8", "9-11", "12-14"))

# Clean up low-information crosses (connectivity data can be very sparse)
VlnPlot(scc.merge, 
        features = 'nFeature_CellToCell',
        group.by = 'Condition',
        pt.size=0.1,
        log = T)
```

```{r}
scc.sub <- subset(scc.merge,nFeature_CellToCell > 5) # Requesting at least 5 distinct ligand-receptor interactions between two cells
```


## Visualize full dataset

```{r}
# Perform initial visualization
scc.sub <- ScaleData(scc.sub)
scc.sub <- FindVariableFeatures(scc.sub,selection.method = "disp")
scc.sub <- RunPCA(scc.sub,npcs = 50)
ElbowPlot(scc.sub,ndim=50)
```

```{r}
scc.sub <- RunUMAP(scc.sub,dims = 1:25)
DimPlot(scc.sub,group.by = 'VectorType')+NoLegend()
```


## Focus on a single cell-cell cross of interest


```{r}
head(unique(scc.sub@meta.data$VectorType))
#[1] "HL-8—HL-8"   "HL-8—HL-10"  "HL-8—EN-19"  "HL-10—HL-8"  "HL-10—HL-10" "HL-10—EN-19"

# Define VectorTypes of interest (note the long em-dash used in NICHES)
VOI <- c("HL-8—HL-8", "HL-8—HL-10", "HL-8—EN-19", "HL-10—HL-8", "HL-10—HL-10", "HL-10—EN-19")

# Loop over VectorTypes of interest, subsetting those interactions, finding markers associated with the comparison of interest (stimulus vs control) and  create a heatmap of top markers:
lapply(VOI, function(x){
 
  #subset
  subs <- subset(scc.sub, subset = VectorType == x)
  
  #print number of cells per condition
  print(paste0(x , ":  5-6:", sum(subs@meta.data$Condition == "5-6")))
  print(paste0(x , ":  7-8:", sum(subs@meta.data$Condition == "7-8")))
  print(paste0(x , ":  9-11:", sum(subs@meta.data$Condition == "9-11")))
  print(paste0(x , ":  12-14:", sum(subs@meta.data$Condition == "12-14")))

  
  #set idents
  Idents(subs) <- subs@meta.data$Condition
  
  #scale the subsetted data
  FindVariableFeatures(subs,assay='CellToCell',selection.method = "disp")
  ScaleData(subs, assay='CellToCell')
  
  #these are the features in the scaledata slot
  feats <- dimnames(subs@assays$CellToCell@scale.data)[[1]]
  feats
  
  #find markers (here we use wilcox, but ROC and other tests can be used as well)
  markers <- FindAllMarkers(subs, features=feats, test.use = "wilcox",assay='CellToCell')
  
  #subset to top 10 markers per condition
  top10 <- markers %>% group_by(cluster) %>% top_n(n = 10, wt = avg_log2FC)
  
  #Make a heatmap
  DoHeatmap(subs,group.by="ident",features=top10$gene, assay="CellToCell") +  ggtitle("", x)
})
```

================================================================================
================================================================================
================================================================================
================================================================================
================================================================================










