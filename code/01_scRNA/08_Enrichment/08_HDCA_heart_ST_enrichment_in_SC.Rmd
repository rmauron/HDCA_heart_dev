---
title: "08_HDCA_heart_ST_enrichment_in_SC"
author: "RaphaÃ«l Mauron"
output: html_document
editor_options: 
  chunk_output_type: console
---

# HDCA heart ST enrichment in SC

In this script, markers from ST clusters are tested for enrichment in SC data.

NOTE: The path to load the data and the path to save the figures should be changed at your convenience.

Environment: **Docker**

## Settings

### Set library path

```{r setup, include=FALSE}
.libPaths("/home/rstudio/project/renv/library/R-4.3/aarch64-unknown-linux-gnu/")
knitr::opts_chunk$set(echo = TRUE)
```


### Set environment variables

```{r}
# Set the directory 
myfolder <- "/home/rstudio/project/output/HDCA_heart_sc_analysis_docker/"
```


### Load Libraries

```{r, message = FALSE}
library(Seurat)
library(Matrix)
library(dplyr)
library(harmony)
library(ggplot2)
library(patchwork)
library(openxlsx)
library(niceRplots)
library(gtools)
library(patchwork)
library(plotly)
```


### Load filtered data

```{r}
data <- readRDS(paste0(myfolder, "rds_objects/HDCA_heart_sc_full_extended.rds"))
CM <- readRDS(file = paste0(myfolder, "rds_objects/cardiomyocytes02.rds"))
EN <- readRDS(file = paste0(myfolder, "rds_objects/endothelial.rds"))
FB <- readRDS(paste0(myfolder, "rds_objects/fibroblasts.rds"))
```


### Set seed

```{r}
set.seed(1)
```


## Gene Set Enrichment Analysis (GSEA) between ST-DEG and SC-clusters

### Load ST-DEG

```{r}
DEG_ST_heart_23cl<- read.xlsx("/home/rstudio/project/data/ST/230904_DE_all_heart_23cl.xlsx",
                                 sheet='230904_DE_all_heart_23cl')
```


## Enrichment in High Level Data

### ST clusters to keep

```{r}
# Get the gene set from single cluster (keep only: 4, 7, 19, 10, 5, 18, 13, 6, 8, 15, 9, 21)
cluster_list <- c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22")
```


#### All ST clusters analyzed separately across all HL sc clusters (Supp Fig. 2B)

```{r}
# Check how many genes per group
table(DEG_ST_heart_23cl$cluster)

# Create list of DEGs
GeneSets <- split(DEG_ST_heart_23cl$gene, DEG_ST_heart_23cl$cluster)

# Compute module score on single-cell data
data <- AddModuleScore(data, features = GeneSets, name = "Enrichment_Score")

# Rename the Enrichment_Score meta.data
# Create new_column_names using the list of numbers
new_column_names <- paste("Enrichment_Score_ST_cluster_", cluster_list, sep = "")

# Use a loop to rename the columns based on the list of indices and names
i_start <- as.numeric(dim(data@meta.data)[2]-length(GeneSets)+1)
i_end <- as.numeric(dim(data@meta.data)[2])
i_column <- as.numeric(dim(data@meta.data)[2]-length(GeneSets))

#dim(data@meta.data)[2] + length(GeneSets)
for (i in i_start:i_end) {
  colnames(data@meta.data)[i] <- new_column_names[i - i_column]
}

# Plot violin plots
# If you have 10 clusters, the scores should now be named Enrichment_Score1, Enrichment_Scoree2, ..., Enrichment_Score10
selected_clusters <- c("4_35", "17", "9", "5", "11", "7", "18_2", "18_1", "33", "28", "12", "24", "32", "3", "21", "13", "30", "2", "23", "1", "14", "16", "31", "8", "10", "22", "20", "25", "26", "15", "29")
data_sub <- data[, data$high_level_clusters_removed %in% selected_clusters]
data_sub$high_level_clusters_removed <- factor(data_sub$high_level_clusters_removed, levels = selected_clusters)


pdf(file = paste0(myfolder, "ST_enrichment/Violin_enrichment_ST_all_HL.pdf"), width = 40, height = 40)
VlnPlot(data_sub, features = new_column_names, group.by = "high_level_clusters_removed", pt.size = 0) + 
  plot_layout(ncol = 2)
dev.off()
```


## Enrichment in Deep Level CM (Supp Fig. 3B)

### ST clusters to keep

```{r}
# Get the gene set from single cluster
cluster_list <- c("0", "1", "2", "3", "4", "5", "7", "9", "12", "15", "17")
```


#### All ST clusters analyzed separately across all HL sc clusters

```{r}
# Check how many genes per group
table(DEG_ST_heart_23cl$cluster)

# Create list of DEGs
GeneSets <- split(DEG_ST_heart_23cl$gene, DEG_ST_heart_23cl$cluster)

# Keep list in GeneSets that corresponds to ST clusters of interest
GeneSets <- GeneSets[cluster_list]

# Compute module score on single-cell data
CM <- AddModuleScore(CM, features = GeneSets, name = "Enrichment_Score")

# Rename the Enrichment_Score meta.data
# Create new_column_names using the list of numbers
new_column_names <- paste("Enrichment_Score_ST_cluster_", cluster_list, sep = "")

# Use a loop to rename the columns based on the list of indices and names
# for (i in 30:52) {
#   colnames(data@meta.data)[i] <- new_column_names[i - 29]
# }
i_start <- as.numeric(dim(CM@meta.data)[2]-length(GeneSets)+1)
i_end <- as.numeric(dim(CM@meta.data)[2])
i_column <- as.numeric(dim(CM@meta.data)[2]-length(GeneSets))

for (i in i_start:i_end) {
  colnames(CM@meta.data)[i] <- new_column_names[i - i_column]
}

# Plot violin plots
# If you have 10 clusters, the scores should now be named Enrichment_Score1, Enrichment_Scoree2, ..., Enrichment_Score10
CM_sub <- CM[, CM$clusters_subset_split %in% c("6",  "1", "10", "8-1", "8-3", "17", "8-2", "18", "4-2",  "4-1", "3", "14",  "9",  "12", "19-2",  "19-1", "7",  "2", "5")]
selected_clusters <- c("6",  "1", "10", "8-1", "8-3", "17", "8-2", "18", "4-2",  "4-1", "3", "14",  "9",  "12", "19-2",  "19-1", "7",  "2", "5")
CM_sub$clusters_subset_split <- factor(CM_sub$clusters_subset_split, levels = selected_clusters)

# Plot
pdf(file = paste0(myfolder, "ST_enrichment/Violin_enrichment_ST_subset_CM.pdf"), width = 40, height = 20)
VlnPlot(CM_sub, features = new_column_names, group.by = "clusters_subset_split", pt.size = 0) +
  plot_layout(ncol = 2)
dev.off()
```


## Enrichment in Deep Level EN (Supp Fig. 5C)

### ST clusters to keep

```{r}
# Get the gene set from single cluster
cluster_list <- c("5", "9", "10", "18", "19")
```


#### All ST clusters analyzed separately across all HL sc clusters

```{r}
# Check how many genes per group
table(DEG_ST_heart_23cl$cluster)

# Create list of DEGs
GeneSets <- split(DEG_ST_heart_23cl$gene, DEG_ST_heart_23cl$cluster)

# Keep list in GeneSets that corresponds to ST clusters of interest
GeneSets <- GeneSets[cluster_list]

# Compute module score on single-cell data
EN <- AddModuleScore(EN, features = GeneSets, name = "Enrichment_Score")

# Rename the Enrichment_Score meta.data
# Create new_column_names using the list of numbers
new_column_names <- paste("Enrichment_Score_ST_cluster_", cluster_list, sep = "")

# Use a loop to rename the columns based on the list of indices and names
# for (i in 30:52) {
#   colnames(data@meta.data)[i] <- new_column_names[i - 29]
# }
i_start <- as.numeric(dim(EN@meta.data)[2]-length(GeneSets)+1)
i_end <- as.numeric(dim(EN@meta.data)[2])
i_column <- as.numeric(dim(EN@meta.data)[2]-length(GeneSets))

for (i in i_start:i_end) {
  colnames(EN@meta.data)[i] <- new_column_names[i - i_column]
}

# Plot violin plots
# If you have 10 clusters, the scores should now be named Enrichment_Score1, Enrichment_Scoree2, ..., Enrichment_Score10
EN_sub <- EN[, EN$clusters_subset %in% c("1", "12", "3", "6", "18", "17", "7", "19", "15", "13", "10", "2", "5", "21", "16", "20", "11", "14")]
selected_clusters <- mixedsort(unique(EN_sub@meta.data[["clusters_subset"]]))
EN$clusters_subset <- factor(EN_sub$clusters_subset, levels = c("1", "12", "3", "6", "18", "17", "7", "19", "15", "13", "10", "2", "5", "21", "16", "20", "11", "14"))

# Plot
pdf(file = paste0(myfolder, "ST_enrichment/Violin_enrichment_ST_subset_EN.pdf"), width = 40, height = 10)
VlnPlot(EN_sub, features = new_column_names, group.by = "clusters_subset", pt.size = 0) + 
  plot_layout(ncol = 2)
dev.off()
```


## Enrichment in Deep Level FB (Supp Fig. 6F)

### ST clusters to keep

```{r}
# Get the gene set from single cluster
cluster_list <- c("0", "1", "2", "3", "4", "5", "7", "8", "9", "10", "13", "14", "15", "16", "17")
```


#### All ST clusters analyzed separately across all HL sc clusters

```{r}
# Check how many genes per group
table(DEG_ST_heart_23cl$cluster)

# Create list of DEGs
GeneSets <- split(DEG_ST_heart_23cl$gene, DEG_ST_heart_23cl$cluster)

# Keep list in GeneSets that corresponds to ST clusters of interest
GeneSets <- GeneSets[cluster_list]

# Compute module score on single-cell data
FB <- AddModuleScore(FB, features = GeneSets, name = "Enrichment_Score")

# Rename the Enrichment_Score meta.data
# Create new_column_names using the list of numbers
new_column_names <- paste("Enrichment_Score_ST_cluster_", cluster_list, sep = "")

# Use a loop to rename the columns based on the list of indices and names
# for (i in 30:52) {
#   colnames(data@meta.data)[i] <- new_column_names[i - 29]
# }
i_start <- as.numeric(dim(FB@meta.data)[2]-length(GeneSets)+1)
i_end <- as.numeric(dim(FB@meta.data)[2])
i_column <- as.numeric(dim(FB@meta.data)[2]-length(GeneSets))

for (i in i_start:i_end) {
  colnames(FB@meta.data)[i] <- new_column_names[i - i_column]
}

# Plot violin plots
# If you have 10 clusters, the scores should now be named Enrichment_Score1, Enrichment_Scoree2, ..., Enrichment_Score10
FB_sub <- FB[, FB$clusters_subset %in% c("7", "3", "18", "14", "5", "9", "19", "2", "12", "4", "13", "11", "17", "8", "1", "6", "15", "20")]
selected_clusters <- mixedsort(unique(FB_sub@meta.data[["clusters_subset"]]))
FB$clusters_subset <- factor(FB_sub$clusters_subset, levels = c("7", "3", "18", "14", "5", "9", "19", "2", "12", "4", "13", "11", "17", "8", "1", "6", "15", "20"))

# Plot
pdf(file = paste0(myfolder, "ST_enrichment/Violin_enrichment_ST_subset_FB.pdf"), width = 40, height = 26.6)
VlnPlot(FB_sub, features = new_column_names, group.by = "clusters_subset", pt.size = 0) + 
  plot_layout(ncol = 2)
dev.off()
```


================================================================================
================================================================================
================================================================================
================================================================================
================================================================================
















