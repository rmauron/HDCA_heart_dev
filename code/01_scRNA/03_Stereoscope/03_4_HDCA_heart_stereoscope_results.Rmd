---
title: "03_4_HDCA_heart_stereoscope_results"
author: "Raphaël Mauron"
output: html_document
editor_options: 
  chunk_output_type: console
---

# HDCA heart stereoscope results

A specific environment as been created to run this script. The reason being we are using the package called ´semla´ (https://github.com/ludvigla/semla) which has dependencies and was not installed at the beginning of the overall analysis.
To avoid any dependencies issues, it has been decided to run this code separately.

NOTE: The path to load the data and the path to save the figures should be changed at your convenience.

Environment: **Conda: r-semla**


## Set up and loading material

### Knit setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### Load library

```{r}
library(semla)
library(tidyr)
library(RcppML)
library(ggplot2)
```


### Set working directory

```{r}
myfolder <- "~/hdca_DevHeart/output/HDCA_heart_sc_analysis_docker/stereoscope/"
```


### Load `Seurat` object with ST data

```{r}
ST <- readRDS("~/hdca_DevHeart/data/ST/220114_STdata_harmony_semla.rds")
```


### Update image paths

```{r}
image_files <- list.files(path = "~/hdca_DevHeart/data/ST", 
                          pattern = "tissue_hires_image.png", 
                          full.names = TRUE, 
                          recursive = TRUE)
ST@tools$Staffli@imgs <- image_files
```


### Load H&E images

```{r}
ST <- LoadImages(ST, image_height = 1.5e3)
```


## High Level Analysis

### Load stereoscope results for sampled cells

```{r}
# HL results
stereoscope <- read.table("~/hdca_DevHeart/data/ST/stereoscope/W.2023-09-25133054.715121_hl.tsv", check.names = FALSE)

# Find shares genes
all(colnames(ST) == rownames(stereoscope))
```


### Load stereoscope (deconvolution) results as a new assay

```{r}
stereoscope.assay <- CreateAssayObject(data = stereoscope %>% t())
ST[["stereoscope"]] <- stereoscope.assay
```


### Plot

#### Set default assay to `stereoscope´

```{r}
DefaultAssay(ST) <- "stereoscope"
```


#### Check clusters name

```{r}
rownames(ST)
```


#### Plot all sections (1 patchwork per cluster)
Here we project the gene expression of cluster individually on every section

```{r}
# Create path if not existing
if (!dir.exists(paste0(myfolder, "visualization/high_level"))){
  dir.create(paste0(myfolder, "visualization/high_level"), recursive = TRUE)}

for (celltype in rownames(ST)) {
  p <- MapFeatures(ST,
                   features = celltype,
                   override_plot_dims = TRUE,
                   colors = c("lightgrey","mistyrose", "red", "darkred", "black"),
                   max_cutoff = 0.99, #flattened the expression above 0.99 percentile
                   pt_size = 1.5) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()
  
  jpeg(filename = paste0(myfolder, "visualization/high_level/cell_type_", celltype, ".jpg"), width = 4000, height = 4000, res = 150)
  print(p)
  dev.off()
}
rm(celltype, p)
```


#### Plot all sections (1 patchwork per cluster) - no_cutoff
Here we project the gene expression of cluster individually on every section

```{r}
# Create path if not existing
if (!dir.exists(paste0(myfolder, "visualization/high_level_no_cutoff"))){
  dir.create(paste0(myfolder, "visualization/high_level_no_cutoff"), recursive = TRUE)}

for (celltype in rownames(ST)) {
  p <- MapFeatures(ST,
                   features = celltype,
                   override_plot_dims = TRUE,
                   colors = c("lightgrey","mistyrose", "red", "darkred", "black"),
                   #max_cutoff = 0.99, #flattened the expression above 0.99 percentile
                   pt_size = 1.5) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()
  
  jpeg(filename = paste0(myfolder, "visualization/high_level_no_cutoff/cell_type_", celltype, "_no_cutoff.jpg"), width = 4000, height = 4000, res = 150)
  print(p)
  dev.off()
}
rm(celltype, p)
```


#### Plot on subset of sections

```{r}
# Create path if not existing
if (!dir.exists(paste0(myfolder, "visualization/high_level_figures"))){
  dir.create(paste0(myfolder, "visualization/figures"), recursive = TRUE)}

for (celltype in rownames(ST)) {
  p <- MapFeatures(ST,
                   features = celltype,
                   override_plot_dims = TRUE,
                   colors = c("lightgrey","mistyrose", "red", "darkred", "black"),
                   max_cutoff = 0.99, #flattened the expression above 0.99 percentile
                   pt_size = 1.5)
  
  p5 <- p[[5]] & theme(plot.subtitle = element_blank(), legend.position = "none")
  p2 <- p[[2]] & theme(plot.subtitle = element_blank(), legend.position = "none")
  p11 <- p[[11]] & theme(plot.subtitle = element_blank(), legend.position = "none")
  p24 <- p[[24]] & theme(plot.subtitle = element_blank(), legend.position = "right", legend.text = element_text(angle = 0))

  pg <- p5 + p2 + p11 + p24  +
    patchwork::plot_layout(ncol = 4)
  
  pdf(file = paste0(myfolder, "visualization/high_level_figures/cell_type_", celltype, ".pdf"), width = 15.75, height = 4.5)
  print(pg)
  dev.off()
}
rm(p, p2, p5, p11, p24, pg)
```


#### Plot on subset of sections - no_cutoff

```{r}
# Create path if not existing
if (!dir.exists(paste0(myfolder, "visualization/high_level_figures_no_cutoff"))){
  dir.create(paste0(myfolder, "visualization/high_level_figures_no_cutoff"), recursive = TRUE)}

for (celltype in rownames(ST)) {
  p <- MapFeatures(ST,
                   features = celltype,
                   override_plot_dims = TRUE,
                   colors = c("lightgrey","mistyrose", "red", "darkred", "black"),
                   #max_cutoff = 0.99, #flattened the expression above 0.99 percentile
                   pt_size = 1.5)
  
  p5 <- p[[5]] & theme(plot.subtitle = element_blank(), legend.position = "none")
  p2 <- p[[2]] & theme(plot.subtitle = element_blank(), legend.position = "none")
  p11 <- p[[11]] & theme(plot.subtitle = element_blank(), legend.position = "none")
  p24 <- p[[24]] & theme(plot.subtitle = element_blank(), legend.position = "right", legend.text = element_text(angle = 0))

  pg <- p5 + p2 + p11 + p24  +
    patchwork::plot_layout(ncol = 4)
  
  pdf(file = paste0(myfolder, "visualization/high_level_figures_no_cutoff/cell_type_", celltype, "_no_cutoff.pdf"), width = 15.75, height = 4.5)
  print(pg)
  dev.off()
}
rm(p, p2, p5, p11, p24, pg)
```


## Deep Level Clustering Analysis

### Cardiomyocytes, Endothelial cells, Fibroblasts (together)

#### Load stereoscope results for sampled cells

```{r}
# Deep level results
stereoscope_deep_lvl <- read.table("~/hdca_DevHeart/data/ST/stereoscope/W.2023-10-28105405.918149_dl.tsv", check.names = FALSE)

# Find shares genes
all(colnames(ST) == rownames(stereoscope_deep_lvl))
```


#### Load stereoscope (deconvolution) results as a new assay

```{r}
stereoscope_deep_lvl.assay <- CreateAssayObject(data = stereoscope_deep_lvl %>% t())
ST[["stereoscope_deep_lvl"]] <- stereoscope_deep_lvl.assay
```


### Plot

#### Set default assay to `stereoscope´

```{r}
DefaultAssay(ST) <- "stereoscope_deep_lvl"
```


#### Check clusters name

```{r}
rownames(ST)
```


#### Plot all sections (1 patchwork per cluster)
Here we project the gene expression of cluster individually on every section

```{r}
#Create path if not existing
if (!dir.exists(paste0(myfolder, "/visualization/deep_level/"))){
  dir.create(paste0(myfolder, "/visualization/deep_level/"))}

for (celltype in rownames(ST)) {
  p <- MapFeatures(ST,
                   features = celltype,
                   override_plot_dims = TRUE,
                   colors = c("lightgrey","mistyrose", "red", "darkred", "black"),
                   max_cutoff = 0.99, #flattened the expression above 0.99 percentile
                   pt_size = 1.5) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()

  jpeg(filename = paste0(myfolder, "/visualization/deep_level/", celltype, ".jpg"), width = 4000, height = 4000, res = 150)
  print(p)
  dev.off()
}
```


#### Plot all sections (1 patchwork per cluster) - no_cutoff
Here we project the gene expression of cluster individually on every section

```{r}
#Create path if not existing
if (!dir.exists(paste0(myfolder, "/visualization/deep_level_no_cutoff/"))){
  dir.create(paste0(myfolder, "/visualization/deep_level_no_cutoff/"))}

for (celltype in rownames(ST)) {
  p <- MapFeatures(ST,
                   features = celltype,
                   override_plot_dims = TRUE,
                   colors = c("lightgrey","mistyrose", "red", "darkred", "black"),
                   #max_cutoff = 0.99, #flattened the expression above 0.99 percentile
                   pt_size = 1.5) +
    patchwork::plot_layout(guides = "collect") &
    theme(plot.subtitle = element_blank()) &
    ThemeLegendRight()

  jpeg(filename = paste0(myfolder, "/visualization/deep_level_no_cutoff/", celltype, "_no_cutoff.jpg"), width = 4000, height = 4000, res = 150)
  print(p)
  dev.off()
}
```


#### Plot on subset of sections

```{r}
# Create path if not existing
if (!dir.exists(paste0(myfolder, "visualization/deep_level_figures/"))){
  dir.create(paste0(myfolder, "visualization/deep_level_figures/"), recursive = TRUE)}

for (celltype in rownames(ST)) {
  p <- MapFeatures(ST,
                   features = celltype,
                   override_plot_dims = TRUE,
                   colors = c("lightgrey","mistyrose", "red", "darkred", "black"),
                   max_cutoff = 0.99, #flattened the expression above 0.99 percentile
                   pt_size = 1.5)
  
  p5 <- p[[5]] & theme(plot.subtitle = element_blank(), legend.position = "none")
  p2 <- p[[2]] & theme(plot.subtitle = element_blank(), legend.position = "none")
  p11 <- p[[11]] & theme(plot.subtitle = element_blank(), legend.position = "none")
  p24 <- p[[24]] & theme(plot.subtitle = element_blank(), legend.position = "right", legend.text = element_text(angle = 0))

  pg <- p5 + p2 + p11 + p24  +
    patchwork::plot_layout(ncol = 4)
  
  pdf(file = paste0(myfolder, "visualization/deep_level_figures/", celltype, ".pdf"), width = 15.75, height = 4.5)
  print(pg)
  dev.off()
}
rm(p, p2, p5, p11, p24, pg)
```


#### Plot on subset of sections - no_cutoff

```{r}
# Create path if not existing
if (!dir.exists(paste0(myfolder, "visualization/deep_level_figures_no_cutoff/"))){
  dir.create(paste0(myfolder, "visualization/deep_level_figures_no_cutoff/"), recursive = TRUE)}

for (celltype in rownames(ST)) {
  p <- MapFeatures(ST,
                   features = celltype,
                   override_plot_dims = TRUE,
                   colors = c("lightgrey","mistyrose", "red", "darkred", "black"),
                   #max_cutoff = 0.99, #flattened the expression above 0.99 percentile
                   pt_size = 1.5)
  
  p5 <- p[[5]] & theme(plot.subtitle = element_blank(), legend.position = "none")
  p2 <- p[[2]] & theme(plot.subtitle = element_blank(), legend.position = "none")
  p11 <- p[[11]] & theme(plot.subtitle = element_blank(), legend.position = "none")
  p24 <- p[[24]] & theme(plot.subtitle = element_blank(), legend.position = "right", legend.text = element_text(angle = 0))

  pg <- p5 + p2 + p11 + p24  +
    patchwork::plot_layout(ncol = 4)
  
  pdf(file = paste0(myfolder, "visualization/deep_level_figures_no_cutoff/", celltype, "_no_cutoff.pdf"), width = 15.75, height = 4.5)
  print(pg)
  dev.off()
}
rm(p, p2, p5, p11, p24, pg)
```


================================================================================
================================================================================
================================================================================
================================================================================
================================================================================











