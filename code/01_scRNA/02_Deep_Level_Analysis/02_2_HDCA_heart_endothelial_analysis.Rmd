---
title: "02_2_HDCA_heart_endothelial_analysis"
author: "Julia Foyer, Ludvig Larsson & RaphaÃ«l Mauron"
output: html_document
editor_options: 
  chunk_output_type: console
---

# HDCA heart endothelial analysis

In this script, a subset of the *high level* data generated in the script `01_HDCA_heart_QC_and_high_level_analysis.Rmd` is selected and re-clustered and analyzed accordingly. It is part of the *deep level* analysis.

NOTE: The path to load the data and the path to save the figures should be changed at your convenience.

Environment: **Docker**


## Settings

### Set library path

```{r setup, include=FALSE}
.libPaths("/home/rstudio/project/renv/library/R-4.3/aarch64-unknown-linux-gnu/")
knitr::opts_chunk$set(echo = TRUE)
```


### Load Libraries

```{r, message = FALSE}
library(Seurat)
library(Matrix)
library(dplyr)
library(harmony)
library(ggplot2)
library(patchwork)
library(openxlsx)
library(plotly)
```


### Set environment variables

```{r}
# Set the directory 
myfolder <- "/home/rstudio/project/output/HDCA_heart_sc_analysis_docker/"
```


### Load global functions

```{r}
source("/home/rstudio/project/code/global_functions.R")
```


### Load filtered data

```{r}
data <- readRDS(paste0(myfolder, "rds_objects/HDCA_heart_sc_full_extended.rds"))
```


### Set seed

```{r}
set.seed(1)
```


## Subset, process, clustering (Extended Fig. 3A)

* Keep all cells annotated as endothelial
* Calculate variable features
* Scale data while regressing out "nCount_RNA", "nFeature_RNA", "percent_ribo", "percent_mito", "percent_hb", "percent_hsp", "S.Score" and "G2M.Score
* Run PCA on scaled data (50 PCs)
* Run harmony (batch correction, 50 PCs)
* Compute UMAP (50 PCs)
* Construct knn adjacency matrix with hnsw_knn
* Cluster cells using cluster_louvain

```{r, message=FALSE}
# Subset the data to keep only endothelial cells
EN <- data[,data$cell.types == "Endoc_EC"      |
            data$cell.types == "MicroVasc_EC"  |
            data$cell.types == "EndocCush_EC"  |
            data$cell.types == "PDE4Chigh_EC"  |
            data$cell.types == "MacroVasc_EC"  |
            data$cell.types == "LEC"           |
            data$cell.types == "TMSB10high_C_2"]
           
# Remove all genes with 0 counts
EN <- EN[rowSums(GetAssayData(EN, slot = "counts")) > 0, ]

# Process the data
EN <- EN %>% 
  NormalizeData() %>% 
  FindVariableFeatures(nfeatures = 3000) %>% 
  ScaleData(vars.to.regress = c("nCount_RNA", "nFeature_RNA", 
                                "percent_ribo", "percent_mito", 
                                "percent_hb", "percent_hsp", 
                                "S.Score", "G2M.Score")) 

EN <- RunPCA(EN, npcs = 50, seed.use = 42)

set.seed(15)
EN <- RunHarmony(EN,
                 group.by.vars = c("sampleID"),
                 reduction = "pca",
                 project.dim = F,
                 reduction.save = "harmony_subset")

EN <- RunUMAP(EN,
              dims = 1:50,
              reduction = "harmony_subset",
              n.neighbors = 20,
              metric = "cosine",
              min.dist = 0.3,
              spread = 1,
              repulsion.strength = 1,
              negative.sample.rate = 5,
              n.epochs = 100,
              reduction.key = "subset",
              reduction.name = "umap_subset",
              seed.use = 42)

gc()

# Compute k nearest neighbours
set.seed(1)
nn <- CreateNNAdjacencyMatrix(data = EN, reduction = "harmony_subset", k = 10, dims = 1:50)

# add the clusters to the metadata
cl <- LouvainClustering(nn = nn, seed = 1, resolution = 1.15)
EN$clusters_subset <- factor(cl)

pdf(paste0(myfolder, "endothelial/endothelial_subclusters.pdf"), width = 10, height = 10)
  DimPlot(EN, reduction = "umap_subset", group.by = "clusters_subset", label = T) + labs(title = "Endothelial subclusters") +
  NoLegend()
dev.off()

gc()
```


## Add the annotation

The annotation was imported from an external .csv file. The annotation is added as a new metadata row `cell.types` by matching the cluster numbers.

```{r}
annotation <- read.csv2("/home/rstudio/project/data/metadata/HDCA_heart_SC_annotations_EN_240115.csv", header = 1, sep = ";")
cells_clusters <- setNames(annotation$cell_type, nm = annotation$cluster)
EN$cell.types <- cells_clusters[as.character(EN$clusters_subset)]
rm(annotation, cells_clusters)
gc()
```


## Differentially expressed genes (DEG) for all clusters (Supp Tab. 5)

```{r}
EN <- SetIdent(EN, value = "cell.types")
detable <- FindAllMarkers(EN, logfc.threshold = 0.25,
                          only.pos = TRUE, 
                          min.pct = 0.05)

detable <- detable[detable$p_val_adj < 0.01, ]

# Adding two extra columns giving the difference (and log difference) between pct1 and pct2.
# pct1 is the percentage of cells in the specific cluster that express this gene.
# pct2 is the percentage of cells in all other clusters that express this gene.
detable$pct.diff <- detable$pct.1 - detable$pct.2
detable$log.pct.diff <- log2((detable$pct.1*99+1) / (detable$pct.2*99+1))

# Save the detable as a csv file.
write.csv2(detable, paste0(myfolder, "supplementary_tables/supplementary_table_5_DEG_EN.csv"))
```


### UMAP with annotation (Fig. 5A)

```{r}
values_to_keep <- c("1", "12", "3", "6", "18", "17", "7", "19", "15", "13", "10", "2", "5", "21", "16", "20", "11", "14")

data_EN <- EN[, EN$clusters_subset %in% values_to_keep]

pdf(file = paste0(myfolder, "endothelial/endothelial_clusters_remaining_annot.pdf"), width = 10, height = 10)
DimPlot(data_EN, reduction = "umap_subset", group.by = "cell.types", label = T) + NoLegend() + labs(title = "Entothelial subclusters")
dev.off()
```


### DEG EN - top5 ordered (Supp Fig. 5A)

```{r}
values_to_keep <- c("1", "12", "3", "6", "18", "17", "7", "19", "15", "13", "10", "2", "5", "21", "16", "20", "11", "14")

data_EN <- EN[, EN$clusters_subset %in% values_to_keep]

# Select a new samples size for each cluster, to get groups that are equally (or almost equally) large.
sample_size <- table(data_EN$clusters_subset)
sample_size[sample_size > 150] <- 150
sample_size

# Randomly sample the cells that will be included when calculating DGE (same number of cells as selected above).
# Samples without replacement, so each cell only can be included once.
DGE_cells <- lapply(names(sample_size), function(x){ 
  set.seed(1)
  sample(colnames(data_EN)[data_EN$clusters_subset == x], size = sample_size[x])
  })
DGE_cells <- unlist(DGE_cells)

# Select all data that relates to the sampled DGE cells.
DGE_DATA <- data_EN[, DGE_cells]

# reorder the cell types desired
DGE_DATA$cell.types <- factor(DGE_DATA$cell.types, 
                                              levels = c("Endoc_EC_1", 
                                                         "Endoc_EC_2", 
                                                         "Endoc_EC_3", 
                                                         "Endoc_EC_4", 
                                                         "AtrSept_EC", 
                                                         "IF_VEC", 
                                                         "OF_VEC", 
                                                         "Art_EC_1", 
                                                         "Art_EC_2", 
                                                         "Arteriol_EC", 
                                                         "Cap_EC_1", 
                                                         "Cap_EC_2", 
                                                         "Prol_EC", 
                                                         "Venul_EC", 
                                                         "Ven_EC", 
                                                         "LEC^fg", 
                                                         "TMSB10high_C_2^fg", 
                                                         "PDE4Chigh_EC^fg"))

DGE_DATA <- SetIdent(DGE_DATA, value = "cell.types")

# The logfc threshold is set to 0.1 as compared to the default 0.25, which makes the detection of weaker signals possible (but it takes more computational power).
detable <- FindAllMarkers(DGE_DATA,
                          only.pos = TRUE,
                          max.cells.per.ident = 300,
                          logfc.threshold = .1,
                          assay = "RNA",
                          min.pct = 0.05)

detable <- detable[detable$p_val < 0.05, ]

# Adding two extra columns giving the difference (and log difference) between pct1 and pct2.
# pct1 is the percentage of cells in the specific cluster that express this gene.
# pct2 is the percentage of cells in all other clusters that express this gene.
detable$pct.diff <- detable$pct.1 - detable$pct.2
detable$log.pct.diff <- log2((detable$pct.1*99+1) / (detable$pct.2*99+1))

# Pick the 40 genes with the lowest p value for each cluster, then 20 highest based on pct.diff, then 5 highest based on avg_log2FC.
detable %>%
  group_by(cluster) %>%
  top_n(-40, p_val) %>%
  top_n(20, pct.diff) %>%
  top_n(5, avg_log2FC) ->
  top5

pdf(paste0(myfolder, "endothelial/DEG_top5_EN_ordered.pdf"), width = 10, height = 17)
par(mfrow=c(1,1), mar=c(3,6,2,5))
DotPlot(DGE_DATA, features = top5 %>% pull(gene) %>% unique()) +
  coord_flip() +
  theme(axis.text.y = element_text(angle = 0, hjust = 1, vjust = 0.5)) +
  scale_color_gradientn(colours = RColorBrewer::brewer.pal(n = 11, name = "RdBu") %>% rev()) +
  scale_x_discrete(limits = rev) +
  scale_y_discrete() +
  labs(x = "", y = "") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
dev.off()

gc()
rm(detable, DGE_DATA, top5, DGE_cells, sample_size)
```


### DEG EN-7, EN-17, EN-18 - top10 ordered (Supp Fig. 5F)

```{r}
values_to_keep <- c("18", "17", "7")

data_EN <- EN[, EN$clusters_subset %in% values_to_keep]

# Select a new samples size for each cluster, to get groups that are equally (or almost equally) large.
sample_size <- table(data_EN$clusters_subset)
sample_size[sample_size > 150] <- 150
sample_size

# Randomly sample the cells that will be included when calculating DGE (same number of cells as selected above).
# Samples without replacement, so each cell only can be included once.
DGE_cells <- lapply(names(sample_size), function(x){ 
  set.seed(1)
  sample(colnames(data_EN)[data_EN$clusters_subset == x], size = sample_size[x])
  })
DGE_cells <- unlist(DGE_cells)

# Select all data that relates to the sampled DGE cells.
DGE_DATA <- data_EN[, DGE_cells]

# reorder the cell types desired
DGE_DATA$cell.types <- factor(DGE_DATA$cell.types, 
                                              levels = c("AtrSept_EC", 
                                                         "IF_VEC", 
                                                         "OF_VEC"))

DGE_DATA <- SetIdent(DGE_DATA, value = "cell.types")

# The logfc threshold is set to 0.1 as compared to the default 0.25, which makes the detection of weaker signals possible (but it takes more computational power).
detable <- FindAllMarkers(DGE_DATA,
                          only.pos = TRUE,
                          max.cells.per.ident = 300,
                          logfc.threshold = .1,
                          assay = "RNA",
                          min.pct = 0.05)

# Only keep DEG that have a p-value below 0.05.
detable <- detable[detable$p_val < 0.05, ]

# Adding two extra columns giving the difference (and log difference) between pct1 and pct2.
# pct1 is the percentage of cells in the specific cluster that express this gene.
# pct2 is the percentage of cells in all other clusters that express this gene.
detable$pct.diff <- detable$pct.1 - detable$pct.2
detable$log.pct.diff <- log2((detable$pct.1*99+1) / (detable$pct.2*99+1))

# Pick the 40 genes with the lowest p value for each cluster, then 20 highest based on pct.diff, then 5 highest based on avg_log2FC.
detable %>%
  group_by(cluster) %>%
  top_n(-40, p_val) %>%
  top_n(20, pct.diff) %>%
  top_n(10, avg_log2FC) ->
  top10

pdf(paste0(myfolder, "endothelial/DEG_top10_EN7_17_18.pdf"), width = 5, height = 10)
par(mfrow=c(1,1), mar=c(3,6,2,5))
DotPlot(DGE_DATA, features = top10 %>% pull(gene) %>% unique()) +
  coord_flip() +
  theme(axis.text.y = element_text(angle = 0, hjust = 1, vjust = 0.5)) +
  scale_color_gradientn(colours = RColorBrewer::brewer.pal(n = 11, name = "RdBu") %>% rev()) +
  scale_x_discrete(limits = rev) +
  scale_y_discrete() +
  labs(x = "", y = "") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
dev.off()

gc()
rm(detable, DGE_DATA, top5, DGE_cells, sample_size)
```


### DEG EN selection of markers (Extended Fig. 3D)

```{r}
# specific list of marker to project the dotplot on
my_markers <- c("MYH7", "MYH6", "MYBPC3", "TNNI1", "MYOZ2", "FABP3", "TMSB10", "S100A11", "GNG11", "FABP4", "VWF", "CDH5", "PECAM1", "LYVE1", "NPR3", "BMPER", "POSTN", "APCDD1", "TWIST1", "DDR2", "TCF21", "COL1A1", "MYH11", "ENPEP", "ITLN1", "PCSK1N", "MPZ", "C1QC", "JCHAIN", "CD3E", "KLRB1", "UBE2C", "H1-1")

EN <- SetIdent(EN, value = "clusters_subset")

p <- DotPlot(EN, features = my_markers) +
  coord_flip() +
  theme(axis.text.y = element_text(angle = 0, hjust = 1, vjust = 0.5)) +
  scale_color_gradientn(colours = RColorBrewer::brewer.pal(n = 11, name = "RdBu") %>% rev()) +
  scale_x_discrete(limits = rev) +
  scale_y_discrete() +
  labs(x = "", y = "") + 
  theme(axis.text.x = element_text(angle = 30, hjust = 1, size = 8))

pdf(paste0(myfolder, "endothelial/dotplot_markers_EN.pdf"), width = 8, height = 8)
print(p)
dev.off()

rm(p)
gc()
```


### DEG EN selection of markers (reviewer 2)

```{r}
# specific list of marker to project the dotplot on
my_markers <- c("GJA5", "ASS1", "HEY1", "S100A4", "SOX17", "PLAUR", "EFNB2", "ACKR1", "ICAM1", "EGR2", "LRG1", "IRF1", "SELP", "SELE", "CLU", "VWF", "TEK", "S1PR1", "S1PR2", "S1PR3", "S1PR4", "S1PR5", "ADRB1", "ADRB2", "ADRB3", "RAPGEF3", "RAPGEF4", "CDH2", "TRIO", "TFRC", "FLT1", "KDR", "CDH5", "HRH1", "HRH2", "HRH3", "HRH4", "PTK2", "BDKRB1", "BDKRB2", "ANGPT1", "ANGPT2", "CCL14")


values_to_keep <- c("1", "12", "3", "6", "18", "17", "7", "19", "15", "13", "10", "2", "5", "21", "16", "20", "11", "14")

data_EN <- EN[, EN$clusters_subset %in% values_to_keep]

data_EN$clusters_subset <- factor(data_EN$clusters_subset, 
                                              levels = values_to_keep)

data_EN <- SetIdent(data_EN, value = "clusters_subset")

p <- DotPlot(data_EN, features = my_markers) +
  coord_flip() +
  theme(axis.text.y = element_text(angle = 0, hjust = 1, vjust = 0.5)) +
  scale_color_gradientn(colours = RColorBrewer::brewer.pal(n = 11, name = "RdBu") %>% rev()) +
  scale_x_discrete(limits = rev) +
  scale_y_discrete() +
  labs(x = "", y = "") + 
  theme(axis.text.x = element_text(angle = 30, hjust = 1, size = 8))

pdf(paste0(myfolder, "endothelial/dotplot_markers_EN_reviewer2.pdf"), width = 8, height = 9)
print(p)
dev.off()

rm(p)
gc()
```


### FeaturePlot (Supp Fig. 5B)

```{r}
values_to_keep <- c("1", "12", "3", "6", "18", "17", "7", "19", "15", "13", "10", "2", "5", "21", "16", "20", "11", "14")

data_EN <- EN[, EN$clusters_subset %in% values_to_keep]

feature_list <- c("NPR3", "APCDD1", "FABP4", "GJA5", "GABBR2", "RGCC", "APLNR", "LYVE1", "MKI67")

for (feature in feature_list){
  p <-   FeaturePlot(data_EN, reduction = "umap_subset", features = feature, raster = FALSE, order = FALSE)

  pdf(paste0(myfolder, "endothelial/feature_plots/", feature, ".pdf"), width = 10, height = 10)
  print(p)
  dev.off()
}
```


## Export endothelial cells metadata and Seurat object

```{r}
saveRDS(EN[[]], paste0(myfolder, "rds_objects/endothelial_metadata.rds"))
saveRDS(EN, paste0(myfolder, "rds_objects/endothelial.rds"))
```

```{r}
EN <- readRDS(file = paste0(myfolder, "rds_objects/endothelial.rds"))
```


================================================================================
================================================================================
================================================================================
================================================================================
================================================================================












